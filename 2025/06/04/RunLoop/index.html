<!DOCTYPE html>
<html lang="zh-Hans">
    
    <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport" />
    <meta name="description" content="RunLoop æ·±å…¥ç†è§£" />
    <meta name="hexo-theme-A4" content="v2.0.0" />
    <link rel="alternate icon" type="image/webp" href="/img/avatar.png">
    <title>Floki</title>

    
        
<link rel="stylesheet" href="/css/highlight/style1.css">

        
<link rel="stylesheet" href="/css/reset.css">

        
<link rel="stylesheet" href="/css/markdown.css">

        
<link rel="stylesheet" href="/css/fonts.css">
 
         <!--æ³¨æ„ï¼šé¦–é¡µæ—¢ä¸æ˜¯postä¹Ÿä¸æ˜¯page-->
        
        
        
<link rel="stylesheet" href="/css/ui.css">
 
        
<link rel="stylesheet" href="/css/style.css">


        
            <!--è¿”å›é¡¶éƒ¨css-->
            
<link rel="stylesheet" href="/css/returnToTop.css">

            
<link rel="stylesheet" href="/css/unicons.css">

        
        
            <!--ç›®å½•-->
            
<link rel="stylesheet" href="/css/toc.css">

        
    

    
        
<link rel="stylesheet" href="/css/returnToLastPage.css">

    
    
   
<link rel="stylesheet" href="/css/lightgallery-bundle.min.css">


   
        
<link rel="stylesheet" href="/css/custom.css">

    
    <link rel='stylesheet' href='https://chinese-fonts-cdn.deno.dev/packages/lxgwwenkai/dist/LXGWWenKai-Regular/result.css' /> 
<meta name="generator" content="Hexo 8.1.1"></head>
    
    

    
    



    

    
    




    
    


    <body>
        <script src="/js/darkmode-js.min.js"></script>
        
        <script>
            const options = {
                bottom: '40px', // default: '32px'
                right: 'unset', // default: '32px'
                left: '42px', // default: 'unset'
                time: '0.3s', // default: '0.3s'
                mixColor: '#fff', // default: '#fff'
                backgroundColor: ' #e4e4e4 ',  // default: '#fff'
                buttonColorDark: '#100f2c',  // default: '#100f2c'
                buttonColorLight: '#fff', // default: '#fff'
                saveInCookies: true, // default: true,
                label: 'ğŸŒ“', // default: ''
                autoMatchOsTheme: true // default: true
            }
            const darkmode = new Darkmode(options);
            darkmode.showWidget();
        </script>
        
        
            
                <div class="left-toc-container">
                    <nav id="toc" class="bs-docs-sidebar"></nav>
                </div>
            
        
        <div class="paper">

            

            
                <div class="shadow-drop-2-bottom paper-main">
                    


<div class="header">
    <div class="header-container">
        <style>
            .header-img {
                width: 56px;
                height: auto;
                object-fit: cover; /* ä¿æŒå›¾ç‰‡æ¯”ä¾‹ */
                transition: transform 0.3s ease-in-out; 
                border-radius: 0; 
            }
            
        </style>
        <img 
            alt="^-^" 
            cache-control="max-age=86400" 
            class="header-img" 
            src="/img/avatar.png" 
        />
        <div class="header-content">
            <a class="logo" href="/">Floki</a> 
            <span class="description">ä¸€ä¸ªå†™ä½œçˆ±å¥½è€…çš„åœ¨çº¿ç¬”è®°æœ¬</span> 
        </div>
    </div>
    
   
    <ul class="nav">
        
            
                <li><a href="/">ğŸ–¼ï¸é¦–é¡µ</a></li>
            
        
            
                <li><a href="/list/">ğŸ“šæ–‡ç« </a></li>
            
        
            
                <li><a href="/about/">ğŸˆï¸å…³äº</a></li>
            
        
            
                <li><a href="/tags/">ğŸ”ï¸æ ‡ç­¾</a></li>
            
        
            
                <li><a href="/categories/">ğŸ²åˆ†ç±»</a></li>
            
        
            
                <li><a href="/now/">ğŸ§ŠNow</a></li>
            
        
    </ul>
</div>

                    
                    

                    
                    

                    <!--è¯´æ˜æ˜¯æ–‡ç« posté¡µé¢-->
                    
                        <div class="post-main">
    

    
        
            
                <div class="post-main-title" style="text-align: center;">
                    RunLoop æ·±å…¥ç†è§£
                </div>
            
        
      
    

    

        
            <div class="post-head-meta-center">
        
                
                    <span>æœ€è¿‘æ›´æ–°ï¼š2026-01-02</span> 
                
                
                    
                        &nbsp; | &nbsp;
                    
                     <span>å­—æ•°æ€»è®¡ï¼š4.6k</span>
                
                
                    
                        &nbsp; | &nbsp;
                    
                    <span>é˜…è¯»ä¼°æ—¶ï¼š24åˆ†é’Ÿ</span>
                
                
                    
                        &nbsp; | &nbsp;
                    
                    <span id="busuanzi_container_page_pv">
                        é˜…è¯»é‡ï¼š<span id="busuanzi_value_page_pv"></span>æ¬¡
                    </span>
                
            </div>
    

    <div class="post-md">
        
            
                <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#1-RunLoop-%E6%A6%82%E8%BF%B0"><span class="post-toc-text">1. RunLoop æ¦‚è¿°</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-1-%E4%BB%80%E4%B9%88%E6%98%AF-RunLoop%EF%BC%9F"><span class="post-toc-text">1.1 ä»€ä¹ˆæ˜¯ RunLoopï¼Ÿ</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-2-%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84"><span class="post-toc-text">1.2 ç³»ç»Ÿæ¶æ„</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#2-CFRunLoop-%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="post-toc-text">2. CFRunLoop æ ¸å¿ƒæºç åˆ†æ</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-1-%E6%A0%B8%E5%BF%83%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="post-toc-text">2.1 æ ¸å¿ƒæ•°æ®ç»“æ„</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#2-1-1-CFRunLoop-%E7%BB%93%E6%9E%84%E4%BD%93"><span class="post-toc-text">2.1.1 CFRunLoop ç»“æ„ä½“</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#2-1-2-CFRunLoopMode-%E7%BB%93%E6%9E%84%E4%BD%93"><span class="post-toc-text">2.1.2 CFRunLoopMode ç»“æ„ä½“</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-2-%E6%A0%B8%E5%BF%83%E8%BF%90%E8%A1%8C%E9%80%BB%E8%BE%91%E6%BA%90%E7%A0%81"><span class="post-toc-text">2.2 æ ¸å¿ƒè¿è¡Œé€»è¾‘æºç </span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#2-2-1-CFRunLoopRun-%E5%85%A5%E5%8F%A3%E5%87%BD%E6%95%B0"><span class="post-toc-text">2.2.1 CFRunLoopRun å…¥å£å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#2-2-2-CFRunLoopRunSpecific-%E6%A0%B8%E5%BF%83%E5%AE%9E%E7%8E%B0"><span class="post-toc-text">2.2.2 CFRunLoopRunSpecific æ ¸å¿ƒå®ç°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#2-2-3-CFRunLoopRun-%E6%A0%B8%E5%BF%83%E5%BE%AA%E7%8E%AF"><span class="post-toc-text">2.2.3 __CFRunLoopRun æ ¸å¿ƒå¾ªç¯</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#3-RunLoop-Mode-%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90"><span class="post-toc-text">3. RunLoop Mode æ·±å…¥è§£æ</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-1-Mode-%E7%9A%84%E6%9C%AC%E8%B4%A8"><span class="post-toc-text">3.1 Mode çš„æœ¬è´¨</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-2-%E7%B3%BB%E7%BB%9F%E9%A2%84%E5%AE%9A%E4%B9%89%E7%9A%84-Mode"><span class="post-toc-text">3.2 ç³»ç»Ÿé¢„å®šä¹‰çš„ Mode</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-3-CommonModes-%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="post-toc-text">3.3 CommonModes çš„å®ç°åŸç†</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#4-%E4%BA%94%E5%A4%A7%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="post-toc-text">4. äº”å¤§æ ¸å¿ƒç»„ä»¶æºç åˆ†æ</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#4-1-Source0-%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6"><span class="post-toc-text">4.1 Source0 - è§¦æ‘¸äº‹ä»¶</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-1-1-Source0-%E7%BB%93%E6%9E%84%E4%BD%93"><span class="post-toc-text">4.1.1 Source0 ç»“æ„ä½“</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-1-2-Source0-%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B"><span class="post-toc-text">4.1.2 Source0 å¤„ç†æµç¨‹</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#4-2-Source1-%E7%B3%BB%E7%BB%9F%E5%86%85%E6%A0%B8%E4%BA%8B%E4%BB%B6"><span class="post-toc-text">4.2 Source1 - ç³»ç»Ÿå†…æ ¸äº‹ä»¶</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-2-1-Source1-%E7%BB%93%E6%9E%84%E4%BD%93"><span class="post-toc-text">4.2.1 Source1 ç»“æ„ä½“</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-2-2-Source1-%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B"><span class="post-toc-text">4.2.2 Source1 å¤„ç†æµç¨‹</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#4-3-Timer-%E5%AE%9A%E6%97%B6%E5%99%A8"><span class="post-toc-text">4.3 Timer - å®šæ—¶å™¨</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-3-1-Timer-%E7%BB%93%E6%9E%84%E4%BD%93"><span class="post-toc-text">4.3.1 Timer ç»“æ„ä½“</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-3-2-Timer-%E8%A7%A6%E5%8F%91%E9%80%BB%E8%BE%91"><span class="post-toc-text">4.3.2 Timer è§¦å‘é€»è¾‘</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#4-4-Observer-%E8%A7%82%E5%AF%9F%E8%80%85"><span class="post-toc-text">4.4 Observer - è§‚å¯Ÿè€…</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-4-1-Observer-%E7%BB%93%E6%9E%84%E4%BD%93"><span class="post-toc-text">4.4.1 Observer ç»“æ„ä½“</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-4-2-Observer-%E8%A7%A6%E5%8F%91%E9%80%BB%E8%BE%91"><span class="post-toc-text">4.4.2 Observer è§¦å‘é€»è¾‘</span></a></li></ol></li></ol></li></ol>
            
        
        <div class=".article-gallery"><h2 id="1-RunLoop-æ¦‚è¿°"><a href="#1-RunLoop-æ¦‚è¿°" class="headerlink" title="1. RunLoop æ¦‚è¿°"></a>1. RunLoop æ¦‚è¿°</h2><h3 id="1-1-ä»€ä¹ˆæ˜¯-RunLoopï¼Ÿ"><a href="#1-1-ä»€ä¹ˆæ˜¯-RunLoopï¼Ÿ" class="headerlink" title="1.1 ä»€ä¹ˆæ˜¯ RunLoopï¼Ÿ"></a>1.1 ä»€ä¹ˆæ˜¯ RunLoopï¼Ÿ</h3><p><strong>å®˜æ–¹å®šä¹‰</strong>ï¼šRunLoop æ˜¯ä¸€ä¸ªäº‹ä»¶å¤„ç†å¾ªç¯ï¼Œç”¨äºæŒç»­è°ƒåº¦å’Œåè°ƒæ¥æ”¶åˆ°çš„äº‹ä»¶ã€‚</p>
<p><strong>å¤§ç™½è¯</strong>ï¼šRunLoop å°±åƒä¸€ä¸ª<strong>æ°¸ä¸åœæ­‡çš„é—¨å«</strong>ï¼Œä¸æ–­åœ°ï¼š</p>
<ul>
<li>ğŸ‘‚ ç›‘å¬äº‹ä»¶ï¼ˆè§¦æ‘¸ã€å®šæ—¶å™¨ã€ç½‘ç»œï¼‰</li>
<li>ğŸƒ å¤„ç†ä»»åŠ¡</li>
<li>ğŸ˜´ ä¼‘çœ ç­‰å¾…ï¼ˆæ²¡äº‹æ—¶ç¡è§‰ï¼ŒèŠ‚çœ CPUï¼‰</li>
</ul>
<p><a href="/../img/RunLoop/image-20260102154558760.png" title="image-20260102154558760" class="gallery-item" style="box-shadow: none;"> <img src="/../img/RunLoop/image-20260102154558760.png" alt="image-20260102154558760"></a></p>
<h3 id="1-2-ç³»ç»Ÿæ¶æ„"><a href="#1-2-ç³»ç»Ÿæ¶æ„" class="headerlink" title="1.2 ç³»ç»Ÿæ¶æ„"></a>1.2 ç³»ç»Ÿæ¶æ„</h3><p><a href="/../img/RunLoop/image-20260102154732008.png" title="image-20260102154732008" class="gallery-item" style="box-shadow: none;"> <img src="/../img/RunLoop/image-20260102154732008.png" alt="image-20260102154732008"></a></p>
<p><strong>å…³é”®ç‚¹</strong>ï¼š</p>
<ul>
<li><code>CFRunLoop</code> æ˜¯æ ¸å¿ƒå®ç°ï¼ˆå¼€æºï¼‰</li>
<li><code>NSRunLoop</code> æ˜¯ OC å°è£…ï¼ˆä¸å¼€æºï¼‰</li>
<li>åº•å±‚åŸºäº <code>mach_msg()</code> å®ç°çº¿ç¨‹ä¼‘çœ </li>
</ul>
<hr>
<h2 id="2-CFRunLoop-æ ¸å¿ƒæºç åˆ†æ"><a href="#2-CFRunLoop-æ ¸å¿ƒæºç åˆ†æ" class="headerlink" title="2. CFRunLoop æ ¸å¿ƒæºç åˆ†æ"></a>2. CFRunLoop æ ¸å¿ƒæºç åˆ†æ</h2><h3 id="2-1-æ ¸å¿ƒæ•°æ®ç»“æ„"><a href="#2-1-æ ¸å¿ƒæ•°æ®ç»“æ„" class="headerlink" title="2.1 æ ¸å¿ƒæ•°æ®ç»“æ„"></a>2.1 æ ¸å¿ƒæ•°æ®ç»“æ„</h3><h4 id="2-1-1-CFRunLoop-ç»“æ„ä½“"><a href="#2-1-1-CFRunLoop-ç»“æ„ä½“" class="headerlink" title="2.1.1 CFRunLoop ç»“æ„ä½“"></a>2.1.1 CFRunLoop ç»“æ„ä½“</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CFRunLoop.c - æ ¸å¿ƒæ•°æ®ç»“æ„</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">CFRunLoop</span> &#123;</span></span><br><span class="line">    CFRuntimeBase _base;</span><br><span class="line">    <span class="type">pthread_mutex_t</span> _lock;           <span class="comment">// ğŸ”’ äº’æ–¥é”,ä¿è¯çº¿ç¨‹å®‰å…¨</span></span><br><span class="line">    __CFPort _wakeUpPort;             <span class="comment">// ğŸ”” ç”¨äºå”¤é†’çº¿ç¨‹çš„ mach_port</span></span><br><span class="line">    Boolean _unused;</span><br><span class="line">    <span class="keyword">volatile</span> _per_run_data *_perRunData;  <span class="comment">// ğŸ”„ æœ¬æ¬¡è¿è¡Œçš„æ•°æ®</span></span><br><span class="line">    <span class="type">pthread_t</span> _pthread;               <span class="comment">// ğŸ§µ æ‰€å±çº¿ç¨‹</span></span><br><span class="line">    <span class="type">uint32_t</span> _winthread;</span><br><span class="line">    CFMutableSetRef _commonModes;     <span class="comment">// ğŸ“¦ å­˜å‚¨æ‰€æœ‰ common mode çš„å­—ç¬¦ä¸²</span></span><br><span class="line">    CFMutableSetRef _commonModeItems; <span class="comment">// ğŸ“‹ å­˜å‚¨æ‰€æœ‰æ ‡è®°ä¸º common çš„ Source/Timer/Observer</span></span><br><span class="line">    CFRunLoopModeRef _currentMode;    <span class="comment">// ğŸ¯ å½“å‰è¿è¡Œçš„ mode</span></span><br><span class="line">    CFMutableSetRef _modes;           <span class="comment">// ğŸ“š æ‰€æœ‰ mode çš„é›†åˆ</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">block_item</span> *_<span class="title">blocks_head</span>;</span> <span class="comment">// ğŸ§± å¾…æ‰§è¡Œçš„ block é“¾è¡¨å¤´</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">block_item</span> *_<span class="title">blocks_tail</span>;</span> <span class="comment">// ğŸ§± å¾…æ‰§è¡Œçš„ block é“¾è¡¨å°¾</span></span><br><span class="line">    CFAbsoluteTime _runTime;</span><br><span class="line">    CFAbsoluteTime _sleepTime;</span><br><span class="line">    CFTypeRef _counterpart;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>å›¾è§£</strong>ï¼š</p>
<p><a href="/../img/RunLoop/image-20260102154946413.png" title="image-20260102154946413" class="gallery-item" style="box-shadow: none;"> <img src="/../img/RunLoop/image-20260102154946413.png" alt="image-20260102154946413"></a></p>
<p><strong>å…³é”®æºç è§£è¯»</strong>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–å½“å‰çº¿ç¨‹çš„ RunLoop</span></span><br><span class="line">CFRunLoopRef <span class="title function_">CFRunLoopGetCurrent</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    CHECK_FOR_FORK();</span><br><span class="line">    CFRunLoopRef rl = (CFRunLoopRef)_CFGetTSD(__CFTSDKeyRunLoop);</span><br><span class="line">    <span class="keyword">if</span> (rl) <span class="keyword">return</span> rl;</span><br><span class="line">    <span class="comment">// ğŸ‘‡ é‡ç‚¹ï¼šå¦‚æœä¸å­˜åœ¨,è‡ªåŠ¨åˆ›å»º</span></span><br><span class="line">    <span class="keyword">return</span> _CFRunLoopGet0(pthread_self());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–ä¸»çº¿ç¨‹çš„ RunLoop</span></span><br><span class="line">CFRunLoopRef <span class="title function_">CFRunLoopGetMain</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    CHECK_FOR_FORK();</span><br><span class="line">    <span class="type">static</span> CFRunLoopRef __main = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">// ğŸ‘‡ é‡ç‚¹ï¼šä¸»çº¿ç¨‹ RunLoop åœ¨é¦–æ¬¡è·å–æ—¶åˆ›å»º,æ°¸ä¸é”€æ¯</span></span><br><span class="line">    <span class="keyword">if</span> (!__main) __main = _CFRunLoopGet0(pthread_main_thread_np());</span><br><span class="line">    <span class="keyword">return</span> __main;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>å…³é”®ç»“è®º</strong>ï¼š</p>
<ol>
<li>âœ… RunLoop ä¸çº¿ç¨‹æ˜¯<strong>ä¸€ä¸€å¯¹åº”</strong>çš„å…³ç³»</li>
<li>âœ… ä¸»çº¿ç¨‹ RunLoop è‡ªåŠ¨åˆ›å»ºä¸”æ°¸ä¸é”€æ¯</li>
<li>âœ… å­çº¿ç¨‹ RunLoop <strong>éœ€è¦æ‰‹åŠ¨è·å–</strong>æ‰ä¼šåˆ›å»º</li>
<li>âœ… çº¿ç¨‹é”€æ¯æ—¶ï¼ŒRunLoop ä¹Ÿä¼šè¢«é”€æ¯</li>
</ol>
<h4 id="2-1-2-CFRunLoopMode-ç»“æ„ä½“"><a href="#2-1-2-CFRunLoopMode-ç»“æ„ä½“" class="headerlink" title="2.1.2 CFRunLoopMode ç»“æ„ä½“"></a>2.1.2 CFRunLoopMode ç»“æ„ä½“</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">CFRunLoopMode</span> &#123;</span></span><br><span class="line">    CFRuntimeBase _base;</span><br><span class="line">    <span class="type">pthread_mutex_t</span> _lock;          <span class="comment">// ğŸ”’ äº’æ–¥é”</span></span><br><span class="line">    CFStringRef _name;               <span class="comment">// ğŸ·ï¸ Mode åç§°,å¦‚ &quot;kCFRunLoopDefaultMode&quot;</span></span><br><span class="line">    Boolean _stopped;                <span class="comment">// â¹ï¸ æ˜¯å¦å·²åœæ­¢</span></span><br><span class="line">    <span class="type">char</span> _padding[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ğŸ‘‡ äº”å¤§æ ¸å¿ƒé›†åˆ</span></span><br><span class="line">    CFMutableSetRef _sources0;       <span class="comment">// ğŸ“± Source0 é›†åˆ (è§¦æ‘¸ã€æ»šåŠ¨ç­‰)</span></span><br><span class="line">    CFMutableSetRef _sources1;       <span class="comment">// ğŸ“¡ Source1 é›†åˆ (ç³»ç»Ÿäº‹ä»¶)</span></span><br><span class="line">    CFMutableArrayRef _observers;    <span class="comment">// ğŸ‘ï¸ Observer æ•°ç»„ (ç›‘å¬çŠ¶æ€)</span></span><br><span class="line">    CFMutableArrayRef _timers;       <span class="comment">// â° Timer æ•°ç»„</span></span><br><span class="line"></span><br><span class="line">    CFMutableDictionaryRef _portToV1SourceMap;  <span class="comment">// ğŸ—ºï¸ Port åˆ° Source1 çš„æ˜ å°„</span></span><br><span class="line">    __CFPortSet _portSet;            <span class="comment">// ğŸ”Œ æ‰€æœ‰éœ€è¦ç›‘å¬çš„ port é›†åˆ</span></span><br><span class="line">    CFIndex _observerMask;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_DISPATCH_SOURCE_FOR_TIMERS</span></span><br><span class="line">    <span class="type">dispatch_source_t</span> _timerSource;  <span class="comment">// â±ï¸ GCD Timer Source</span></span><br><span class="line">    <span class="type">dispatch_queue_t</span> _queue;</span><br><span class="line">    Boolean _timerFired;</span><br><span class="line">    Boolean _dispatchTimerArmed;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_MK_TIMER_TOO</span></span><br><span class="line">    __CFPort _timerPort;             <span class="comment">// â²ï¸ Mach Timer Port</span></span><br><span class="line">    Boolean _mkTimerArmed;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DEPLOYMENT_TARGET_WINDOWS</span></span><br><span class="line">    DWORD _msgQMask;</span><br><span class="line">    <span class="type">void</span> (*_msgPump)(<span class="type">void</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="type">uint64_t</span> _timerSoftDeadline;</span><br><span class="line">    <span class="type">uint64_t</span> _timerHardDeadline;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>å›¾è§£</strong>ï¼š</p>
<p><a href="/../img/RunLoop/image-20260102155035805.png" title="image-20260102155035805" class="gallery-item" style="box-shadow: none;"> <img src="/../img/RunLoop/image-20260102155035805.png" alt="image-20260102155035805"></a></p>
<h3 id="2-2-æ ¸å¿ƒè¿è¡Œé€»è¾‘æºç "><a href="#2-2-æ ¸å¿ƒè¿è¡Œé€»è¾‘æºç " class="headerlink" title="2.2 æ ¸å¿ƒè¿è¡Œé€»è¾‘æºç "></a>2.2 æ ¸å¿ƒè¿è¡Œé€»è¾‘æºç </h3><h4 id="2-2-1-CFRunLoopRun-å…¥å£å‡½æ•°"><a href="#2-2-1-CFRunLoopRun-å…¥å£å‡½æ•°" class="headerlink" title="2.2.1 CFRunLoopRun å…¥å£å‡½æ•°"></a>2.2.1 CFRunLoopRun å…¥å£å‡½æ•°</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CFRunLoop.c - RunLoop è¿è¡Œçš„å…¥å£å‡½æ•°</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">CFRunLoopRun</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="type">int32_t</span> result;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// ğŸ‘‡ æ ¸å¿ƒï¼šä»¥ Default æ¨¡å¼è¿è¡Œ,è¶…æ—¶æ—¶é—´ä¸º 10^10 ç§’(çº¦317å¹´)</span></span><br><span class="line">        result = CFRunLoopRunSpecific(CFRunLoopGetCurrent(),</span><br><span class="line">                                     kCFRunLoopDefaultMode,</span><br><span class="line">                                     <span class="number">1.0e10</span>,  <span class="comment">// è¶…æ—¶æ—¶é—´</span></span><br><span class="line">                                     <span class="literal">false</span>);  <span class="comment">// ä¸å¼ºåˆ¶è¿”å›</span></span><br><span class="line">        CHECK_FOR_FORK();</span><br><span class="line">    &#125; <span class="keyword">while</span> (kCFRunLoopRunStopped != result &amp;&amp; kCFRunLoopRunFinished != result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>å…³é”®ç‚¹</strong>ï¼š</p>
<ul>
<li><code>CFRunLoopRun()</code> æ˜¯å¯¹ <code>CFRunLoopRunSpecific()</code> çš„å°è£…</li>
<li>é»˜è®¤ä»¥ <code>kCFRunLoopDefaultMode</code> æ¨¡å¼è¿è¡Œ</li>
<li>è®¾ç½®äº†ä¸€ä¸ª<strong>å‡ ä¹æ— é™</strong>çš„è¶…æ—¶æ—¶é—´</li>
</ul>
<h4 id="2-2-2-CFRunLoopRunSpecific-æ ¸å¿ƒå®ç°"><a href="#2-2-2-CFRunLoopRunSpecific-æ ¸å¿ƒå®ç°" class="headerlink" title="2.2.2 CFRunLoopRunSpecific æ ¸å¿ƒå®ç°"></a>2.2.2 CFRunLoopRunSpecific æ ¸å¿ƒå®ç°</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CFRunLoop.c - RunLoop è¿è¡Œçš„æ ¸å¿ƒå‡½æ•°</span></span><br><span class="line">SInt32 <span class="title function_">CFRunLoopRunSpecific</span><span class="params">(CFRunLoopRef rl, CFStringRef modeName,</span></span><br><span class="line"><span class="params">                            CFTimeInterval seconds, Boolean returnAfterSourceHandled)</span> &#123;</span><br><span class="line">    CHECK_FOR_FORK();</span><br><span class="line">    <span class="keyword">if</span> (__CFRunLoopIsDeallocating(rl)) <span class="keyword">return</span> kCFRunLoopRunFinished;</span><br><span class="line"></span><br><span class="line">    __CFRunLoopLock(rl);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ğŸ‘‡ 1. æ ¹æ® modeName æŸ¥æ‰¾å¯¹åº”çš„ mode</span></span><br><span class="line">    CFRunLoopModeRef currentMode = __CFRunLoopFindMode(rl, modeName, <span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == currentMode || __CFRunLoopModeIsEmpty(rl, currentMode, rl-&gt;_currentMode)) &#123;</span><br><span class="line">        Boolean did = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (currentMode) __CFRunLoopModeUnlock(currentMode);</span><br><span class="line">        __CFRunLoopUnlock(rl);</span><br><span class="line">        <span class="keyword">return</span> did ? kCFRunLoopRunHandledSource : kCFRunLoopRunFinished;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ğŸ‘‡ 2. ä¿å­˜æ—§çš„ mode,è®¾ç½®æ–°çš„ mode</span></span><br><span class="line">    CFRunLoopModeRef previousMode = rl-&gt;_currentMode;</span><br><span class="line">    rl-&gt;_currentMode = currentMode;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ğŸ‘‡ 3. å‘é€é€šçŸ¥: RunLoop å³å°†è¿›å…¥ (kCFRunLoopEntry)</span></span><br><span class="line">    __CFRunLoopDoObservers(rl, currentMode, kCFRunLoopEntry);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ğŸ‘‡ 4. æ ¸å¿ƒå¾ªç¯é€»è¾‘</span></span><br><span class="line">    <span class="type">int32_t</span> result = kCFRunLoopRunFinished;</span><br><span class="line">    result = __CFRunLoopRun(rl, currentMode, seconds, returnAfterSourceHandled, previousMode);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ğŸ‘‡ 5. å‘é€é€šçŸ¥: RunLoop å³å°†é€€å‡º (kCFRunLoopExit)</span></span><br><span class="line">    __CFRunLoopDoObservers(rl, currentMode, kCFRunLoopExit);</span><br><span class="line"></span><br><span class="line">    __CFRunLoopModeUnlock(currentMode);</span><br><span class="line">    __CFRunLoopUnlock(rl);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>æµç¨‹å›¾</strong>ï¼š</p>
<p><a href="/../img/RunLoop/image-20260102155313622.png" title="image-20260102155313622" class="gallery-item" style="box-shadow: none;"> <img src="/../img/RunLoop/image-20260102155313622.png" alt="image-20260102155313622"></a></p>
<h4 id="2-2-3-CFRunLoopRun-æ ¸å¿ƒå¾ªç¯"><a href="#2-2-3-CFRunLoopRun-æ ¸å¿ƒå¾ªç¯" class="headerlink" title="2.2.3 __CFRunLoopRun æ ¸å¿ƒå¾ªç¯"></a>2.2.3 __CFRunLoopRun æ ¸å¿ƒå¾ªç¯</h4><p>è¿™æ˜¯ RunLoop çš„<strong>å¿ƒè„</strong>ï¼Œæ‰€æœ‰é€»è¾‘éƒ½åœ¨è¿™é‡Œï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CFRunLoop.c - RunLoop çš„æ ¸å¿ƒå¾ªç¯é€»è¾‘</span></span><br><span class="line"><span class="type">static</span> <span class="type">int32_t</span> __CFRunLoopRun(CFRunLoopRef rl, CFRunLoopModeRef rlm,</span><br><span class="line">                              CFTimeInterval seconds, Boolean stopAfterHandle,</span><br><span class="line">                              CFRunLoopModeRef previousMode) &#123;</span><br><span class="line">    <span class="type">uint64_t</span> startTSR = mach_absolute_time();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ğŸ‘‡ æ£€æŸ¥æ˜¯å¦å·²åœæ­¢</span></span><br><span class="line">    <span class="keyword">if</span> (__CFRunLoopIsStopped(rl)) &#123;</span><br><span class="line">        __CFRunLoopUnsetStopped(rl);</span><br><span class="line">        <span class="keyword">return</span> kCFRunLoopRunStopped;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rlm-&gt;_stopped) &#123;</span><br><span class="line">        rlm-&gt;_stopped = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span> kCFRunLoopRunStopped;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ğŸ‘‡ mach port ç›¸å…³å˜é‡</span></span><br><span class="line">    <span class="type">mach_port_name_t</span> dispatchPort = MACH_PORT_NULL;</span><br><span class="line">    Boolean libdispatchQSafe = pthread_main_np() &amp;&amp;</span><br><span class="line">        ((HANDLE_DISPATCH_ON_BASE_INVOCATION_ONLY &amp;&amp; <span class="literal">NULL</span> == previousMode) ||</span><br><span class="line">         (!HANDLE_DISPATCH_ON_BASE_INVOCATION_ONLY &amp;&amp; <span class="number">0</span> == _CFGetTSD(__CFTSDKeyIsInGCDMainQ)));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (libdispatchQSafe &amp;&amp; (CFRunLoopGetMain() == rl) &amp;&amp;</span><br><span class="line">        CFSetContainsValue(rl-&gt;_commonModes, rlm-&gt;_name))</span><br><span class="line">        dispatchPort = _dispatch_get_main_queue_port_4CF();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_DISPATCH_SOURCE_FOR_TIMERS</span></span><br><span class="line">    <span class="type">mach_port_name_t</span> modeQueuePort = MACH_PORT_NULL;</span><br><span class="line">    <span class="keyword">if</span> (rlm-&gt;_queue) &#123;</span><br><span class="line">        modeQueuePort = _dispatch_runloop_root_queue_get_port_4CF(rlm-&gt;_queue);</span><br><span class="line">        <span class="keyword">if</span> (!modeQueuePort) &#123;</span><br><span class="line">            CRASH(<span class="string">&quot;Unable to get port for run loop mode queue (%d)&quot;</span>, <span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="type">dispatch_source_t</span> timeout_timer = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> __<span class="title">timeout_context</span> *<span class="title">timeout_context</span> =</span> (<span class="keyword">struct</span> __timeout_context *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(*timeout_context));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ğŸ‘‡ è®¾ç½®è¶…æ—¶æ—¶é—´</span></span><br><span class="line">    <span class="keyword">if</span> (seconds &lt;= <span class="number">0.0</span>) &#123;</span><br><span class="line">        seconds = <span class="number">0.0</span>;</span><br><span class="line">        timeout_context-&gt;termTSR = <span class="number">0ULL</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (seconds &lt;= TIMER_INTERVAL_LIMIT) &#123;</span><br><span class="line">        <span class="type">dispatch_queue_t</span> <span class="built_in">queue</span> = pthread_main_np() ?</span><br><span class="line">            __CFDispatchQueueGetGenericMatchingMain() :</span><br><span class="line">            __CFDispatchQueueGetGenericBackground();</span><br><span class="line">        timeout_timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, <span class="number">0</span>, <span class="number">0</span>, <span class="built_in">queue</span>);</span><br><span class="line">        dispatch_retain(timeout_timer);</span><br><span class="line">        timeout_context-&gt;ds = timeout_timer;</span><br><span class="line">        timeout_context-&gt;rl = (CFRunLoopRef)CFRetain(rl);</span><br><span class="line">        timeout_context-&gt;termTSR = startTSR + __CFTimeIntervalToTSR(seconds);</span><br><span class="line">        dispatch_set_context(timeout_timer, timeout_context);</span><br><span class="line">        dispatch_source_set_event_handler_f(timeout_timer, __CFRunLoopTimeout);</span><br><span class="line">        dispatch_source_set_cancel_handler_f(timeout_timer, __CFRunLoopTimeoutCancel);</span><br><span class="line">        <span class="type">uint64_t</span> ns_at = (<span class="type">uint64_t</span>)((__CFTSRToTimeInterval(startTSR) + seconds) * <span class="number">1000000000ULL</span>);</span><br><span class="line">        dispatch_source_set_timer(timeout_timer, dispatch_time(<span class="number">1</span>, ns_at), DISPATCH_TIME_FOREVER, <span class="number">1000ULL</span>);</span><br><span class="line">        dispatch_resume(timeout_timer);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        seconds = <span class="number">9999999999.0</span>;</span><br><span class="line">        timeout_context-&gt;termTSR = UINT64_MAX;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Boolean didDispatchPortLastTime = <span class="literal">true</span>;</span><br><span class="line">    <span class="type">int32_t</span> retVal = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ğŸ‘‡ æ ¸å¿ƒ do-while å¾ªç¯</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="type">voucher_mach_msg_state_t</span> voucherState = VOUCHER_MACH_MSG_STATE_UNCHANGED;</span><br><span class="line">        <span class="type">voucher_t</span> voucherCopy = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">uint8_t</span> msg_buffer[<span class="number">3</span> * <span class="number">1024</span>];</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DEPLOYMENT_TARGET_MACOSX || DEPLOYMENT_TARGET_EMBEDDED || DEPLOYMENT_TARGET_EMBEDDED_MINI</span></span><br><span class="line">        <span class="type">mach_msg_header_t</span> *msg = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="type">mach_port_t</span> livePort = MACH_PORT_NULL;</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> DEPLOYMENT_TARGET_WINDOWS</span></span><br><span class="line">        HANDLE livePort = <span class="literal">NULL</span>;</span><br><span class="line">        Boolean windowsMessageReceived = <span class="literal">false</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        __CFPortSet waitSet = rlm-&gt;_portSet;</span><br><span class="line"></span><br><span class="line">        __CFRunLoopUnsetIgnoreWakeUps(rl);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ğŸ‘‡ 2. é€šçŸ¥ Observers: å³å°†å¤„ç† Timers (kCFRunLoopBeforeTimers)</span></span><br><span class="line">        <span class="keyword">if</span> (rlm-&gt;_observerMask &amp; kCFRunLoopBeforeTimers)</span><br><span class="line">            __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeTimers);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ğŸ‘‡ 3. é€šçŸ¥ Observers: å³å°†å¤„ç† Sources (kCFRunLoopBeforeSources)</span></span><br><span class="line">        <span class="keyword">if</span> (rlm-&gt;_observerMask &amp; kCFRunLoopBeforeSources)</span><br><span class="line">            __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeSources);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ğŸ‘‡ 4. æ‰§è¡Œè¢«åŠ å…¥çš„ block</span></span><br><span class="line">        __CFRunLoopDoBlocks(rl, rlm);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ğŸ‘‡ 5. å¤„ç† Source0 äº‹ä»¶</span></span><br><span class="line">        Boolean sourceHandledThisLoop = __CFRunLoopDoSources0(rl, rlm, stopAfterHandle);</span><br><span class="line">        <span class="keyword">if</span> (sourceHandledThisLoop) &#123;</span><br><span class="line">            <span class="comment">// ğŸ‘‡ å¦‚æœå¤„ç†äº† Source0,å†æ¬¡æ‰§è¡Œ block</span></span><br><span class="line">            __CFRunLoopDoBlocks(rl, rlm);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ğŸ‘‡ 6. æ£€æŸ¥æ˜¯å¦æœ‰ Source1 å¾…å¤„ç†</span></span><br><span class="line">        Boolean poll = sourceHandledThisLoop || (<span class="number">0ULL</span> == timeout_context-&gt;termTSR);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (MACH_PORT_NULL != dispatchPort &amp;&amp; !didDispatchPortLastTime) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DEPLOYMENT_TARGET_MACOSX || DEPLOYMENT_TARGET_EMBEDDED || DEPLOYMENT_TARGET_EMBEDDED_MINI</span></span><br><span class="line">            <span class="comment">// ğŸ‘‡ å¤„ç† GCD Main Queue çš„æ¶ˆæ¯</span></span><br><span class="line">            msg = (<span class="type">mach_msg_header_t</span> *)msg_buffer;</span><br><span class="line">            <span class="keyword">if</span> (__CFRunLoopServiceMachPort(dispatchPort, &amp;msg, <span class="keyword">sizeof</span>(msg_buffer), &amp;livePort,</span><br><span class="line">                                          <span class="number">0</span>, &amp;voucherState, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">                <span class="keyword">goto</span> handle_msg;</span><br><span class="line">            &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> DEPLOYMENT_TARGET_WINDOWS</span></span><br><span class="line">            <span class="keyword">if</span> (__CFRunLoopWaitForMultipleObjects(<span class="literal">NULL</span>, &amp;dispatchPort, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">                                                 &amp;livePort, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">                <span class="keyword">goto</span> handle_msg;</span><br><span class="line">            &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        didDispatchPortLastTime = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ğŸ‘‡ 7. é€šçŸ¥ Observers: å³å°†ä¼‘çœ  (kCFRunLoopBeforeWaiting)</span></span><br><span class="line">        <span class="keyword">if</span> (!poll &amp;&amp; (rlm-&gt;_observerMask &amp; kCFRunLoopBeforeWaiting))</span><br><span class="line">            __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeWaiting);</span><br><span class="line"></span><br><span class="line">        __CFRunLoopSetSleeping(rl);</span><br><span class="line">        __CFPortSetInsert(dispatchPort, waitSet);</span><br><span class="line"></span><br><span class="line">        __CFRunLoopModeUnlock(rlm);</span><br><span class="line">        __CFRunLoopUnlock(rl);</span><br><span class="line"></span><br><span class="line">        CFAbsoluteTime sleepStart = poll ? <span class="number">0.0</span> : CFAbsoluteTimeGetCurrent();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DEPLOYMENT_TARGET_MACOSX || DEPLOYMENT_TARGET_EMBEDDED || DEPLOYMENT_TARGET_EMBEDDED_MINI</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_DISPATCH_SOURCE_FOR_TIMERS</span></span><br><span class="line">        <span class="comment">// ğŸ‘‡ 8. è¿›å…¥ä¼‘çœ ,ç­‰å¾…æ¶ˆæ¯å”¤é†’ (æ ¸å¿ƒ!)</span></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (kCFUseCollectableAllocator) &#123;</span><br><span class="line">                <span class="comment">// objc_clear_stack(0);</span></span><br><span class="line">                <span class="built_in">memset</span>(msg_buffer, <span class="number">0</span>, <span class="keyword">sizeof</span>(msg_buffer));</span><br><span class="line">            &#125;</span><br><span class="line">            msg = (<span class="type">mach_msg_header_t</span> *)msg_buffer;</span><br><span class="line"></span><br><span class="line">            __CFRunLoopServiceMachPort(waitSet, &amp;msg, <span class="keyword">sizeof</span>(msg_buffer), &amp;livePort,</span><br><span class="line">                                      poll ? <span class="number">0</span> : TIMEOUT_INFINITY, &amp;voucherState, &amp;voucherCopy);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (modeQueuePort != MACH_PORT_NULL &amp;&amp; livePort == modeQueuePort) &#123;</span><br><span class="line">                <span class="comment">// å¤„ç† Timer</span></span><br><span class="line">                <span class="keyword">if</span> (!__CFRunLoopDoTimers(rl, rlm, mach_absolute_time())) &#123;</span><br><span class="line">                    __CFArmNextTimerInMode(rlm, rl);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">voucher_t</span> previousVoucher = _CFSetTSD(__CFTSDKeyMachMessageHasVoucher,</span><br><span class="line">                                                  (<span class="type">void</span> *)voucherCopy, os_release);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">while</span> (<span class="number">1</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        <span class="keyword">if</span> (kCFUseCollectableAllocator) &#123;</span><br><span class="line">            <span class="built_in">memset</span>(msg_buffer, <span class="number">0</span>, <span class="keyword">sizeof</span>(msg_buffer));</span><br><span class="line">        &#125;</span><br><span class="line">        msg = (<span class="type">mach_msg_header_t</span> *)msg_buffer;</span><br><span class="line">        __CFRunLoopServiceMachPort(waitSet, &amp;msg, <span class="keyword">sizeof</span>(msg_buffer), &amp;livePort,</span><br><span class="line">                                  poll ? <span class="number">0</span> : TIMEOUT_INFINITY, &amp;voucherState, &amp;voucherCopy);</span><br><span class="line">        <span class="type">voucher_t</span> previousVoucher = _CFSetTSD(__CFTSDKeyMachMessageHasVoucher,</span><br><span class="line">                                              (<span class="type">void</span> *)voucherCopy, os_release);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> DEPLOYMENT_TARGET_WINDOWS</span></span><br><span class="line">        __CFRunLoopWaitForMultipleObjects(waitSet, <span class="literal">NULL</span>, poll ? <span class="number">0</span> : TIMEOUT_INFINITY,</span><br><span class="line">                                         rlm-&gt;_msgQMask, &amp;livePort, &amp;windowsMessageReceived);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        __CFRunLoopLock(rl);</span><br><span class="line">        __CFRunLoopModeLock(rlm);</span><br><span class="line"></span><br><span class="line">        rl-&gt;_sleepTime += (poll ? <span class="number">0.0</span> : (CFAbsoluteTimeGetCurrent() - sleepStart));</span><br><span class="line"></span><br><span class="line">        __CFPortSetRemove(dispatchPort, waitSet);</span><br><span class="line"></span><br><span class="line">        __CFRunLoopSetIgnoreWakeUps(rl);</span><br><span class="line">        __CFRunLoopUnsetSleeping(rl);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ğŸ‘‡ 9. é€šçŸ¥ Observers: å·²è¢«å”¤é†’ (kCFRunLoopAfterWaiting)</span></span><br><span class="line">        <span class="keyword">if</span> (!poll &amp;&amp; (rlm-&gt;_observerMask &amp; kCFRunLoopAfterWaiting))</span><br><span class="line">            __CFRunLoopDoObservers(rl, rlm, kCFRunLoopAfterWaiting);</span><br><span class="line"></span><br><span class="line">    handle_msg:;</span><br><span class="line">        __CFRunLoopSetIgnoreWakeUps(rl);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DEPLOYMENT_TARGET_WINDOWS</span></span><br><span class="line">        <span class="keyword">if</span> (windowsMessageReceived) &#123;</span><br><span class="line">            <span class="keyword">if</span> (rlm-&gt;_msgPump) &#123;</span><br><span class="line">                rlm-&gt;_msgPump();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="keyword">if</span> (MACH_PORT_NULL == livePort) &#123;</span><br><span class="line">            CFRUNLOOP_WAKEUP_FOR_NOTHING();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (livePort == rl-&gt;_wakeUpPort) &#123;</span><br><span class="line">            <span class="comment">// ğŸ‘‡ è¢« CFRunLoopWakeUp å”¤é†’,ä»€ä¹ˆéƒ½ä¸åš</span></span><br><span class="line">            CFRUNLOOP_WAKEUP_FOR_WAKEUP();</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_DISPATCH_SOURCE_FOR_TIMERS</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (modeQueuePort != MACH_PORT_NULL &amp;&amp; livePort == modeQueuePort) &#123;</span><br><span class="line">            CFRUNLOOP_WAKEUP_FOR_TIMER();</span><br><span class="line">            <span class="comment">// ğŸ‘‡ 10. å¤„ç† Timer äº‹ä»¶</span></span><br><span class="line">            <span class="keyword">if</span> (!__CFRunLoopDoTimers(rl, rlm, mach_absolute_time())) &#123;</span><br><span class="line">                __CFArmNextTimerInMode(rlm, rl);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_MK_TIMER_TOO</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (rlm-&gt;_timerPort != MACH_PORT_NULL &amp;&amp; livePort == rlm-&gt;_timerPort) &#123;</span><br><span class="line">            CFRUNLOOP_WAKEUP_FOR_TIMER();</span><br><span class="line">            <span class="keyword">if</span> (!__CFRunLoopDoTimers(rl, rlm, mach_absolute_time())) &#123;</span><br><span class="line">                __CFArmNextTimerInMode(rlm, rl);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (livePort == dispatchPort) &#123;</span><br><span class="line">            CFRUNLOOP_WAKEUP_FOR_DISPATCH();</span><br><span class="line">            __CFRunLoopModeUnlock(rlm);</span><br><span class="line">            __CFRunLoopUnlock(rl);</span><br><span class="line">            _CFSetTSD(__CFTSDKeyIsInGCDMainQ, (<span class="type">void</span> *)<span class="number">6</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DEPLOYMENT_TARGET_WINDOWS</span></span><br><span class="line">            <span class="type">void</span> *msg = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">            <span class="comment">// ğŸ‘‡ 11. å¤„ç† GCD Main Queue çš„ä»»åŠ¡</span></span><br><span class="line">            __CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__(msg);</span><br><span class="line">            _CFSetTSD(__CFTSDKeyIsInGCDMainQ, (<span class="type">void</span> *)<span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">            __CFRunLoopLock(rl);</span><br><span class="line">            __CFRunLoopModeLock(rlm);</span><br><span class="line">            sourceHandledThisLoop = <span class="literal">true</span>;</span><br><span class="line">            didDispatchPortLastTime = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            CFRUNLOOP_WAKEUP_FOR_SOURCE();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ğŸ‘‡ 12. å¤„ç† Source1 äº‹ä»¶</span></span><br><span class="line">            CFRunLoopSourceRef rls = __CFRunLoopModeFindSourceForMachPort(rl, rlm, livePort);</span><br><span class="line">            <span class="keyword">if</span> (rls) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DEPLOYMENT_TARGET_MACOSX || DEPLOYMENT_TARGET_EMBEDDED || DEPLOYMENT_TARGET_EMBEDDED_MINI</span></span><br><span class="line">                <span class="type">mach_msg_header_t</span> *reply = <span class="literal">NULL</span>;</span><br><span class="line">                sourceHandledThisLoop = __CFRunLoopDoSource1(rl, rlm, rls, msg, msg-&gt;msgh_size, &amp;reply) || sourceHandledThisLoop;</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">NULL</span> != reply) &#123;</span><br><span class="line">                    (<span class="type">void</span>)mach_msg(reply, MACH_SEND_MSG, reply-&gt;msgh_size, <span class="number">0</span>, MACH_PORT_NULL, <span class="number">0</span>, MACH_PORT_NULL);</span><br><span class="line">                    CFAllocatorDeallocate(kCFAllocatorSystemDefault, reply);</span><br><span class="line">                &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> DEPLOYMENT_TARGET_WINDOWS</span></span><br><span class="line">                sourceHandledThisLoop = __CFRunLoopDoSource1(rl, rlm, rls) || sourceHandledThisLoop;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DEPLOYMENT_TARGET_MACOSX || DEPLOYMENT_TARGET_EMBEDDED || DEPLOYMENT_TARGET_EMBEDDED_MINI</span></span><br><span class="line">        <span class="keyword">if</span> (msg &amp;&amp; msg != (<span class="type">mach_msg_header_t</span> *)msg_buffer) <span class="built_in">free</span>(msg);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// ğŸ‘‡ 13. å†æ¬¡æ‰§è¡Œ block</span></span><br><span class="line">        __CFRunLoopDoBlocks(rl, rlm);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ğŸ‘‡ 14. åˆ¤æ–­æ˜¯å¦éœ€è¦é€€å‡º</span></span><br><span class="line">        <span class="keyword">if</span> (sourceHandledThisLoop &amp;&amp; stopAfterHandle) &#123;</span><br><span class="line">            retVal = kCFRunLoopRunHandledSource;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (timeout_context-&gt;termTSR &lt; mach_absolute_time()) &#123;</span><br><span class="line">            retVal = kCFRunLoopRunTimedOut;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__CFRunLoopIsStopped(rl)) &#123;</span><br><span class="line">            __CFRunLoopUnsetStopped(rl);</span><br><span class="line">            retVal = kCFRunLoopRunStopped;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rlm-&gt;_stopped) &#123;</span><br><span class="line">            rlm-&gt;_stopped = <span class="literal">false</span>;</span><br><span class="line">            retVal = kCFRunLoopRunStopped;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__CFRunLoopModeIsEmpty(rl, rlm, previousMode)) &#123;</span><br><span class="line">            retVal = kCFRunLoopRunFinished;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DEPLOYMENT_TARGET_MACOSX || DEPLOYMENT_TARGET_EMBEDDED || DEPLOYMENT_TARGET_EMBEDDED_MINI</span></span><br><span class="line">        voucher_mach_msg_revert(voucherState);</span><br><span class="line">        os_release(voucherCopy);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">while</span> (<span class="number">0</span> == retVal);  <span class="comment">// ğŸ‘ˆ å¾ªç¯æ¡ä»¶: retVal == 0 æ—¶ç»§ç»­</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (timeout_timer) &#123;</span><br><span class="line">        dispatch_source_cancel(timeout_timer);</span><br><span class="line">        dispatch_release(timeout_timer);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">free</span>(timeout_context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> retVal;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>æµç¨‹å›¾</strong>ï¼š</p>
<p><a href="/../img/RunLoop/image-20260102162033881.png" title="image-20260102162033881" class="gallery-item" style="box-shadow: none;"> <img src="/../img/RunLoop/image-20260102162033881.png" alt="image-20260102162033881"></a></p>
<p><strong>å…³é”®æ­¥éª¤æ€»ç»“</strong>ï¼š</p>
<table>
<thead>
<tr>
<th>æ­¥éª¤</th>
<th>æ“ä½œ</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>é€šçŸ¥ Observer</td>
<td>kCFRunLoopBeforeTimers</td>
</tr>
<tr>
<td>2</td>
<td>é€šçŸ¥ Observer</td>
<td>kCFRunLoopBeforeSources</td>
</tr>
<tr>
<td>3</td>
<td>å¤„ç† Blocks</td>
<td>__CFRunLoopDoBlocks</td>
</tr>
<tr>
<td>4</td>
<td>å¤„ç† Source0</td>
<td>__CFRunLoopDoSources0</td>
</tr>
<tr>
<td>5</td>
<td>å¦‚æœæœ‰ GCD æ¶ˆæ¯</td>
<td>å¤„ç† GCD Main Queue</td>
</tr>
<tr>
<td>6</td>
<td>é€šçŸ¥ Observer</td>
<td>kCFRunLoopBeforeWaiting</td>
</tr>
<tr>
<td>7</td>
<td><strong>è¿›å…¥ä¼‘çœ </strong></td>
<td>mach_msg ç­‰å¾…æ¶ˆæ¯</td>
</tr>
<tr>
<td>8</td>
<td><strong>è¢«å”¤é†’</strong></td>
<td>Timer&#x2F;Source1&#x2F;GCD&#x2F;æ‰‹åŠ¨</td>
</tr>
<tr>
<td>9</td>
<td>é€šçŸ¥ Observer</td>
<td>kCFRunLoopAfterWaiting</td>
</tr>
<tr>
<td>10</td>
<td>å¤„ç†å”¤é†’äº‹ä»¶</td>
<td>Timer&#x2F;Source1&#x2F;GCD</td>
</tr>
<tr>
<td>11</td>
<td>å†æ¬¡å¤„ç† Blocks</td>
<td>__CFRunLoopDoBlocks</td>
</tr>
<tr>
<td>12</td>
<td>åˆ¤æ–­é€€å‡ºæ¡ä»¶</td>
<td>è¶…æ—¶&#x2F;åœæ­¢&#x2F;å®Œæˆ</td>
</tr>
</tbody></table>
<hr>
<h2 id="3-RunLoop-Mode-æ·±å…¥è§£æ"><a href="#3-RunLoop-Mode-æ·±å…¥è§£æ" class="headerlink" title="3. RunLoop Mode æ·±å…¥è§£æ"></a>3. RunLoop Mode æ·±å…¥è§£æ</h2><h3 id="3-1-Mode-çš„æœ¬è´¨"><a href="#3-1-Mode-çš„æœ¬è´¨" class="headerlink" title="3.1 Mode çš„æœ¬è´¨"></a>3.1 Mode çš„æœ¬è´¨</h3><p><strong>å®šä¹‰</strong>ï¼šMode æ˜¯ä¸€ä¸ª<strong>è¿‡æ»¤å™¨</strong>ï¼Œå†³å®šäº† RunLoop åœ¨æŸä¸ªçŠ¶æ€ä¸‹å¤„ç†å“ªäº› Source&#x2F;Timer&#x2F;Observerã€‚</p>
<p><strong>æ¯”å–»</strong>ï¼š</p>
<ul>
<li>ğŸª RunLoop æ˜¯ä¸€ä¸ª<strong>24 å°æ—¶ä¾¿åˆ©åº—</strong></li>
<li>ğŸ·ï¸ Mode æ˜¯<strong>ä¸åŒçš„è¥ä¸šæ¨¡å¼</strong>ï¼š<ul>
<li><code>Default</code> æ¨¡å¼ï¼šæ­£å¸¸è¥ä¸šï¼Œå¤„ç†æ‰€æœ‰å•†å“</li>
<li><code>Tracking</code> æ¨¡å¼ï¼šæ¸…ä»“å¤§ç”©å–ï¼Œåªå¤„ç†æ»šåŠ¨äº‹ä»¶</li>
<li><code>UIInitialization</code> æ¨¡å¼ï¼šè£…ä¿®æœŸï¼Œåªå¤„ç†åˆå§‹åŒ–</li>
</ul>
</li>
</ul>
<p><a href="/../img/RunLoop/image-20260102160346112.png" title="image-20260102160346112" class="gallery-item" style="box-shadow: none;"> <img src="/../img/RunLoop/image-20260102160346112.png" alt="image-20260102160346112"></a></p>
<h3 id="3-2-ç³»ç»Ÿé¢„å®šä¹‰çš„-Mode"><a href="#3-2-ç³»ç»Ÿé¢„å®šä¹‰çš„-Mode" class="headerlink" title="3.2 ç³»ç»Ÿé¢„å®šä¹‰çš„ Mode"></a>3.2 ç³»ç»Ÿé¢„å®šä¹‰çš„ Mode</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CFRunLoop.c - ç³»ç»Ÿé¢„å®šä¹‰çš„ Mode åç§°</span></span><br><span class="line"><span class="type">const</span> CFStringRef kCFRunLoopDefaultMode = CFSTR(<span class="string">&quot;kCFRunLoopDefaultMode&quot;</span>);  <span class="comment">// é»˜è®¤æ¨¡å¼</span></span><br><span class="line"><span class="type">const</span> CFStringRef kCFRunLoopCommonModes = CFSTR(<span class="string">&quot;kCFRunLoopCommonModes&quot;</span>);  <span class="comment">// å ä½ç¬¦,æ ‡è®°ä¸º common</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// UIApplication.h - iOS ç‰¹æœ‰çš„ Mode</span></span><br><span class="line">NSString *<span class="type">const</span> UITrackingRunLoopMode;          <span class="comment">// æ»šåŠ¨æ¨¡å¼</span></span><br><span class="line">NSString *<span class="type">const</span> UIModalPanelRunLoopMode;        <span class="comment">// Modal å¼¹çª—æ¨¡å¼</span></span><br><span class="line">NSString *<span class="type">const</span> UIEventTrackingRunLoopMode;     <span class="comment">// äº‹ä»¶è¿½è¸ªæ¨¡å¼</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Foundation - å…¶ä»– Mode</span></span><br><span class="line">NSString *<span class="type">const</span> NSRunLoopCommonModes;           <span class="comment">// OC å°è£…çš„ common å ä½ç¬¦</span></span><br><span class="line">NSString *<span class="type">const</span> NSDefaultRunLoopMode;           <span class="comment">// OC å°è£…çš„é»˜è®¤æ¨¡å¼</span></span><br><span class="line">NSString *<span class="type">const</span> NSEventTrackingRunLoopMode;     <span class="comment">// OC å°è£…çš„äº‹ä»¶è¿½è¸ªæ¨¡å¼</span></span><br><span class="line">NSString *<span class="type">const</span> NSModalPanelRunLoopMode;        <span class="comment">// OC å°è£…çš„ Modal æ¨¡å¼</span></span><br><span class="line">NSString *<span class="type">const</span> NSConnectionReplyMode;          <span class="comment">// NSConnection å›å¤æ¨¡å¼</span></span><br></pre></td></tr></table></figure>

<p><strong>å›¾è§£</strong>ï¼š</p>
<p><a href="/../img/RunLoop/image-20260102160403280.png" title="image-20260102160403280" class="gallery-item" style="box-shadow: none;"> <img src="/../img/RunLoop/image-20260102160403280.png" alt="image-20260102160403280"></a></p>
<h3 id="3-3-CommonModes-çš„å®ç°åŸç†"><a href="#3-3-CommonModes-çš„å®ç°åŸç†" class="headerlink" title="3.3 CommonModes çš„å®ç°åŸç†"></a>3.3 CommonModes çš„å®ç°åŸç†</h3><p><strong>é—®é¢˜</strong>ï¼šä¸ºä»€ä¹ˆ Timer æ·»åŠ åˆ° <code>NSRunLoopCommonModes</code> å°±èƒ½åœ¨ Default å’Œ Tracking æ¨¡å¼ä¸‹éƒ½è¿è¡Œï¼Ÿ</p>
<p><strong>æºç è§£æ</strong>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CFRunLoop.c - æ·»åŠ  Timer çš„æ ¸å¿ƒé€»è¾‘</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">CFRunLoopAddTimer</span><span class="params">(CFRunLoopRef rl, CFRunLoopTimerRef rlt, CFStringRef modeName)</span> &#123;</span><br><span class="line">    CHECK_FOR_FORK();</span><br><span class="line">    <span class="keyword">if</span> (__CFRunLoopIsDeallocating(rl)) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (!__CFIsValid(rlt) || (<span class="literal">NULL</span> != rlt-&gt;_runLoop &amp;&amp; rlt-&gt;_runLoop != rl)) <span class="keyword">return</span>;</span><br><span class="line">    __CFRunLoopLock(rl);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ğŸ‘‡ å…³é”®ï¼šå¦‚æœæ˜¯ CommonModes,åˆ™æ·»åŠ åˆ°æ‰€æœ‰ common mode</span></span><br><span class="line">    <span class="keyword">if</span> (modeName == kCFRunLoopCommonModes) &#123;</span><br><span class="line">        CFSetRef <span class="built_in">set</span> = rl-&gt;_commonModes ? CFSetCreateCopy(kCFAllocatorSystemDefault, rl-&gt;_commonModes) : <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">NULL</span> == rl-&gt;_commonModeItems) &#123;</span><br><span class="line">            rl-&gt;_commonModeItems = CFSetCreateMutable(kCFAllocatorSystemDefault, <span class="number">0</span>, &amp;kCFTypeSetCallBacks);</span><br><span class="line">        &#125;</span><br><span class="line">        CFSetAddValue(rl-&gt;_commonModeItems, rlt);  <span class="comment">// ğŸ‘ˆ æ·»åŠ åˆ° _commonModeItems</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">NULL</span> != <span class="built_in">set</span>) &#123;</span><br><span class="line">            CFTypeRef context[<span class="number">2</span>] = &#123;rl, rlt&#125;;</span><br><span class="line">            CFSetApplyFunction(<span class="built_in">set</span>, (__CFRunLoopAddItemToCommonModes), (<span class="type">void</span> *)context);</span><br><span class="line">            CFRelease(<span class="built_in">set</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ğŸ‘‡ æ™®é€šæ¨¡å¼ï¼šç›´æ¥æ·»åŠ åˆ°æŒ‡å®š mode</span></span><br><span class="line">        CFRunLoopModeRef rlm = __CFRunLoopFindMode(rl, modeName, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">NULL</span> != rlm) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">NULL</span> == rlm-&gt;_timers) &#123;</span><br><span class="line">                CFArrayCallBacks cb = kCFTypeArrayCallBacks;</span><br><span class="line">                cb.equal = <span class="literal">NULL</span>;</span><br><span class="line">                rlm-&gt;_timers = CFArrayCreateMutable(kCFAllocatorSystemDefault, <span class="number">0</span>, &amp;cb);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">NULL</span> != rlm &amp;&amp; !CFSetContainsValue(rlt-&gt;_rlModes, rlm-&gt;_name)) &#123;</span><br><span class="line">            __CFRunLoopTimerLock(rlt);</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">NULL</span> == rlt-&gt;_runLoop) &#123;</span><br><span class="line">                rlt-&gt;_runLoop = rl;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rl != rlt-&gt;_runLoop) &#123;</span><br><span class="line">                __CFRunLoopTimerUnlock(rlt);</span><br><span class="line">                __CFRunLoopModeUnlock(rlm);</span><br><span class="line">                __CFRunLoopUnlock(rl);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            CFSetAddValue(rlt-&gt;_rlModes, rlm-&gt;_name);</span><br><span class="line">            __CFRunLoopTimerUnlock(rlt);</span><br><span class="line">            __CFRunLoopTimerFireTSRLock();</span><br><span class="line">            __CFRepositionTimerInMode(rlm, rlt, <span class="literal">false</span>);</span><br><span class="line">            __CFRunLoopTimerFireTSRUnlock();</span><br><span class="line">            <span class="keyword">if</span> (!_CFExecutableLinkedOnOrAfter(CFSystemVersionLion)) &#123;</span><br><span class="line">                CFRelease(rlt);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">NULL</span> != rlm) &#123;</span><br><span class="line">            __CFRunLoopModeUnlock(rlm);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    __CFRunLoopUnlock(rl);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>å›¾è§£ CommonModes åŸç†</strong>ï¼š</p>
<p><a href="/../img/RunLoop/image-20260102160424010.png" title="image-20260102160424010" class="gallery-item" style="box-shadow: none;"> <img src="/../img/RunLoop/image-20260102160424010.png" alt="image-20260102160424010"></a></p>
<p><strong>å…³é”®ç»“è®º</strong>ï¼š</p>
<ol>
<li>âœ… <code>kCFRunLoopCommonModes</code> <strong>ä¸æ˜¯ä¸€ä¸ªçœŸå®çš„ Mode</strong></li>
<li>âœ… å®ƒæ˜¯ä¸€ä¸ª<strong>æ ‡è®°</strong>ï¼Œè¡¨ç¤ºâ€æ·»åŠ åˆ°æ‰€æœ‰æ ‡è®°ä¸º common çš„ modeâ€</li>
<li>âœ… ç³»ç»Ÿé»˜è®¤å°† <code>kCFRunLoopDefaultMode</code> å’Œ <code>UITrackingRunLoopMode</code> æ ‡è®°ä¸º common</li>
<li>âœ… æ·»åŠ åˆ° CommonModes çš„ Item ä¼šè¢«åŒæ—¶æ·»åŠ åˆ°æ‰€æœ‰ common mode</li>
</ol>
<hr>
<h2 id="4-äº”å¤§æ ¸å¿ƒç»„ä»¶æºç åˆ†æ"><a href="#4-äº”å¤§æ ¸å¿ƒç»„ä»¶æºç åˆ†æ" class="headerlink" title="4. äº”å¤§æ ¸å¿ƒç»„ä»¶æºç åˆ†æ"></a>4. äº”å¤§æ ¸å¿ƒç»„ä»¶æºç åˆ†æ</h2><h3 id="4-1-Source0-è§¦æ‘¸äº‹ä»¶"><a href="#4-1-Source0-è§¦æ‘¸äº‹ä»¶" class="headerlink" title="4.1 Source0 - è§¦æ‘¸äº‹ä»¶"></a>4.1 Source0 - è§¦æ‘¸äº‹ä»¶</h3><h4 id="4-1-1-Source0-ç»“æ„ä½“"><a href="#4-1-1-Source0-ç»“æ„ä½“" class="headerlink" title="4.1.1 Source0 ç»“æ„ä½“"></a>4.1.1 Source0 ç»“æ„ä½“</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CFRunLoop.c - Source0 ç»“æ„ä½“</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">CFRunLoopSource</span> &#123;</span></span><br><span class="line">    CFRuntimeBase _base;</span><br><span class="line">    <span class="type">uint32_t</span> _bits;</span><br><span class="line">    <span class="type">pthread_mutex_t</span> _lock;</span><br><span class="line">    CFIndex _order;                  <span class="comment">// ğŸ“Š ä¼˜å…ˆçº§</span></span><br><span class="line">    CFMutableBagRef _runLoops;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        CFRunLoopSourceContext version0;   <span class="comment">// ğŸ‘ˆ Source0</span></span><br><span class="line">        CFRunLoopSourceContext1 version1;  <span class="comment">// ğŸ‘ˆ Source1</span></span><br><span class="line">    &#125; _context;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Source0 ä¸Šä¸‹æ–‡</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    CFIndex version;</span><br><span class="line">    <span class="type">void</span> *  info;</span><br><span class="line">    <span class="type">const</span> <span class="type">void</span> *(*retain)(<span class="type">const</span> <span class="type">void</span> *info);</span><br><span class="line">    <span class="type">void</span>    (*release)(<span class="type">const</span> <span class="type">void</span> *info);</span><br><span class="line">    CFStringRef (*copyDescription)(<span class="type">const</span> <span class="type">void</span> *info);</span><br><span class="line">    Boolean (*equal)(<span class="type">const</span> <span class="type">void</span> *info1, <span class="type">const</span> <span class="type">void</span> *info2);</span><br><span class="line">    CFHashCode  (*hash)(<span class="type">const</span> <span class="type">void</span> *info);</span><br><span class="line">    <span class="type">void</span>    (*schedule)(<span class="type">void</span> *info, CFRunLoopRef rl, CFStringRef mode);   <span class="comment">// ğŸ‘ˆ åŠ å…¥ RunLoop æ—¶è°ƒç”¨</span></span><br><span class="line">    <span class="type">void</span>    (*cancel)(<span class="type">void</span> *info, CFRunLoopRef rl, CFStringRef mode);     <span class="comment">// ğŸ‘ˆ ç§»é™¤æ—¶è°ƒç”¨</span></span><br><span class="line">    <span class="type">void</span>    (*perform)(<span class="type">void</span> *info);  <span class="comment">// ğŸ‘ˆ æ‰§è¡Œå›è°ƒ,æ ¸å¿ƒ!</span></span><br><span class="line">&#125; CFRunLoopSourceContext;</span><br></pre></td></tr></table></figure>

<h4 id="4-1-2-Source0-å¤„ç†æµç¨‹"><a href="#4-1-2-Source0-å¤„ç†æµç¨‹" class="headerlink" title="4.1.2 Source0 å¤„ç†æµç¨‹"></a>4.1.2 Source0 å¤„ç†æµç¨‹</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CFRunLoop.c - å¤„ç† Source0 çš„å‡½æ•°</span></span><br><span class="line"><span class="type">static</span> Boolean __CFRunLoopDoSources0(CFRunLoopRef rl, CFRunLoopModeRef rlm, Boolean stopAfterHandle) &#123;</span><br><span class="line">    CHECK_FOR_FORK();</span><br><span class="line">    CFTypeRef sources = <span class="literal">NULL</span>;</span><br><span class="line">    Boolean sourceHandled = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    __CFRunLoopModeLock(rlm);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> != rlm-&gt;_sources0 &amp;&amp; <span class="number">0</span> &lt; CFSetGetCount(rlm-&gt;_sources0)) &#123;</span><br><span class="line">        CFSetApplyFunction(rlm-&gt;_sources0, (__CFRunLoopCollectSources0), &amp;sources);</span><br><span class="line">    &#125;</span><br><span class="line">    __CFRunLoopModeUnlock(rlm);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> != sources) &#123;</span><br><span class="line">        __CFRunLoopModeUnlock(rlm);</span><br><span class="line">        __CFRunLoopUnlock(rl);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ğŸ‘‡ éå†æ‰€æœ‰ Source0</span></span><br><span class="line">        CFIndex cnt = CFArrayGetCount(sources);</span><br><span class="line">        CFArraySortValues(sources, CFRangeMake(<span class="number">0</span>, cnt), (__CFRunLoopSourceComparator), <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">for</span> (CFIndex idx = <span class="number">0</span>; idx &lt; cnt; idx++) &#123;</span><br><span class="line">            CFRunLoopSourceRef rls = (CFRunLoopSourceRef)CFArrayGetValueAtIndex(sources, idx);</span><br><span class="line">            __CFRunLoopSourceLock(rls);</span><br><span class="line">            <span class="keyword">if</span> (__CFIsValid(rls)) &#123;</span><br><span class="line">                __CFRunLoopSourceUnsetSignaled(rls);</span><br><span class="line">                <span class="keyword">if</span> (__CFRunLoopSourceIsSignaled(rls)) &#123;</span><br><span class="line">                    __CFRunLoopSourceUnlock(rls);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="literal">NULL</span> != rls-&gt;_context.version0.perform) &#123;</span><br><span class="line">                        <span class="comment">// ğŸ‘‡ æ ¸å¿ƒï¼šè°ƒç”¨ perform å›è°ƒ</span></span><br><span class="line">                        rls-&gt;_context.version0.perform(rls-&gt;_context.version0.info);</span><br><span class="line">                    &#125;</span><br><span class="line">                    CHECK_FOR_FORK();</span><br><span class="line">                    sourceHandled = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">if</span> (stopAfterHandle) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    __CFRunLoopSourceUnlock(rls);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                __CFRunLoopSourceUnlock(rls);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        __CFRunLoopLock(rl);</span><br><span class="line">        __CFRunLoopModeLock(rlm);</span><br><span class="line">        CFRelease(sources);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sourceHandled;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>è§¦æ‘¸äº‹ä»¶å¤„ç†æµç¨‹</strong>ï¼š</p>
<p><a href="/../img/RunLoop/image-20260102160446884.png" title="image-20260102160446884" class="gallery-item" style="box-shadow: none;"> <img src="/../img/RunLoop/image-20260102160446884.png" alt="image-20260102160446884"></a></p>
<p><strong>ä»£ç ç¤ºä¾‹</strong>ï¼šåˆ›å»ºè‡ªå®šä¹‰ Source0</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ViewController.m</span></span><br><span class="line">- (<span class="type">void</span>)createCustomSource0 &#123;</span><br><span class="line">    <span class="comment">// 1. åˆ›å»º Source0 ä¸Šä¸‹æ–‡</span></span><br><span class="line">    <span class="built_in">CFRunLoopSourceContext</span> context = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    context.info = (__bridge <span class="type">void</span> *)<span class="keyword">self</span>;</span><br><span class="line">    context.perform = customSource0Callback;  <span class="comment">// å›è°ƒå‡½æ•°</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. åˆ›å»º Source0</span></span><br><span class="line">    <span class="built_in">CFRunLoopSourceRef</span> source0 = <span class="built_in">CFRunLoopSourceCreate</span>(<span class="literal">NULL</span>, <span class="number">0</span>, &amp;context);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. æ·»åŠ åˆ° RunLoop</span></span><br><span class="line">    <span class="built_in">CFRunLoopAddSource</span>(<span class="built_in">CFRunLoopGetCurrent</span>(), source0, kCFRunLoopDefaultMode);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. æ ‡è®°ä¸ºå¾…å¤„ç†</span></span><br><span class="line">    <span class="built_in">CFRunLoopSourceSignal</span>(source0);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. å”¤é†’ RunLoop</span></span><br><span class="line">    <span class="built_in">CFRunLoopWakeUp</span>(<span class="built_in">CFRunLoopGetCurrent</span>());</span><br><span class="line"></span><br><span class="line">    <span class="built_in">CFRelease</span>(source0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å›è°ƒå‡½æ•°</span></span><br><span class="line"><span class="type">void</span> customSource0Callback(<span class="type">void</span> *info) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;ğŸ“± Source0 å›è°ƒè¢«æ‰§è¡Œ&quot;</span>);</span><br><span class="line">    ViewController *vc = (__bridge ViewController *)info;</span><br><span class="line">    [vc handleCustomEvent];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)handleCustomEvent &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;ğŸ¯ å¤„ç†è‡ªå®šä¹‰äº‹ä»¶&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-Source1-ç³»ç»Ÿå†…æ ¸äº‹ä»¶"><a href="#4-2-Source1-ç³»ç»Ÿå†…æ ¸äº‹ä»¶" class="headerlink" title="4.2 Source1 - ç³»ç»Ÿå†…æ ¸äº‹ä»¶"></a>4.2 Source1 - ç³»ç»Ÿå†…æ ¸äº‹ä»¶</h3><h4 id="4-2-1-Source1-ç»“æ„ä½“"><a href="#4-2-1-Source1-ç»“æ„ä½“" class="headerlink" title="4.2.1 Source1 ç»“æ„ä½“"></a>4.2.1 Source1 ç»“æ„ä½“</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Source1 ä¸Šä¸‹æ–‡</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    CFIndex version;</span><br><span class="line">    <span class="type">void</span> *  info;</span><br><span class="line">    <span class="type">const</span> <span class="type">void</span> *(*retain)(<span class="type">const</span> <span class="type">void</span> *info);</span><br><span class="line">    <span class="type">void</span>    (*release)(<span class="type">const</span> <span class="type">void</span> *info);</span><br><span class="line">    CFStringRef (*copyDescription)(<span class="type">const</span> <span class="type">void</span> *info);</span><br><span class="line">    Boolean (*equal)(<span class="type">const</span> <span class="type">void</span> *info1, <span class="type">const</span> <span class="type">void</span> *info2);</span><br><span class="line">    CFHashCode  (*hash)(<span class="type">const</span> <span class="type">void</span> *info);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> (TARGET_OS_MAC &amp;&amp; !(TARGET_OS_EMBEDDED || TARGET_OS_IPHONE)) || (TARGET_OS_EMBEDDED || TARGET_OS_IPHONE)</span></span><br><span class="line">    <span class="type">mach_port_t</span> (*getPort)(<span class="type">void</span> *info);  <span class="comment">// ğŸ‘ˆ è·å– mach_port</span></span><br><span class="line">    <span class="type">void</span> *  (*perform)(<span class="type">void</span> *msg, CFIndex size, CFAllocatorRef allocator, <span class="type">void</span> *info);  <span class="comment">// ğŸ‘ˆ å¤„ç†æ¶ˆæ¯</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="type">void</span> *  (*getPort)(<span class="type">void</span> *info);</span><br><span class="line">    <span class="type">void</span>    (*perform)(<span class="type">void</span> *info);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125; CFRunLoopSourceContext1;</span><br></pre></td></tr></table></figure>

<h4 id="4-2-2-Source1-å¤„ç†æµç¨‹"><a href="#4-2-2-Source1-å¤„ç†æµç¨‹" class="headerlink" title="4.2.2 Source1 å¤„ç†æµç¨‹"></a>4.2.2 Source1 å¤„ç†æµç¨‹</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CFRunLoop.c - å¤„ç† Source1</span></span><br><span class="line"><span class="type">static</span> Boolean __CFRunLoopDoSource1(CFRunLoopRef rl, CFRunLoopModeRef rlm, CFRunLoopSourceRef rls</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DEPLOYMENT_TARGET_MACOSX || DEPLOYMENT_TARGET_EMBEDDED || DEPLOYMENT_TARGET_EMBEDDED_MINI</span></span><br><span class="line">    , <span class="type">mach_msg_header_t</span> *msg, CFIndex size, <span class="type">mach_msg_header_t</span> **reply</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    , <span class="type">mach_msg_header_t</span> *msg</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    ) &#123;</span><br><span class="line">    CHECK_FOR_FORK();</span><br><span class="line">    Boolean sourceHandled = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    __CFRunLoopSourceLock(rls);</span><br><span class="line">    <span class="keyword">if</span> (__CFIsValid(rls)) &#123;</span><br><span class="line">        __CFRunLoopSourceUnsetSignaled(rls);</span><br><span class="line">        __CFRunLoopSourceUnlock(rls);</span><br><span class="line">        __CFRunLoopDebugInfoForRunLoopSource(rls);</span><br><span class="line">        __CFRunLoopModeUnlock(rlm);</span><br><span class="line">        __CFRunLoopUnlock(rl);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ğŸ‘‡ æ ¸å¿ƒï¼šè°ƒç”¨ Source1 çš„ perform å›è°ƒ</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">NULL</span> != rls-&gt;_context.version1.perform) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DEPLOYMENT_TARGET_MACOSX || DEPLOYMENT_TARGET_EMBEDDED || DEPLOYMENT_TARGET_EMBEDDED_MINI</span></span><br><span class="line">            *reply = rls-&gt;_context.version1.perform(msg, size, kCFAllocatorSystemDefault, rls-&gt;_context.version1.info);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">            rls-&gt;_context.version1.perform(msg, rls-&gt;_context.version1.info);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        &#125;</span><br><span class="line">        CHECK_FOR_FORK();</span><br><span class="line">        sourceHandled = <span class="literal">true</span>;</span><br><span class="line">        __CFRunLoopLock(rl);</span><br><span class="line">        __CFRunLoopModeLock(rlm);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (_LogCFRunLoop) &#123; CFLog(kCFLogLevelDebug, CFSTR(<span class="string">&quot;__CFRunLoopDoSource1 rls %p is invalid&quot;</span>), rls); &#125;</span><br><span class="line">        __CFRunLoopSourceUnlock(rls);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sourceHandled;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>å›¾è§£ Source1 å·¥ä½œåŸç†</strong>ï¼š</p>
<p><a href="/../img/RunLoop/image-20260102160502299.png" title="image-20260102160502299" class="gallery-item" style="box-shadow: none;"> <img src="/../img/RunLoop/image-20260102160502299.png" alt="image-20260102160502299"></a></p>
<h3 id="4-3-Timer-å®šæ—¶å™¨"><a href="#4-3-Timer-å®šæ—¶å™¨" class="headerlink" title="4.3 Timer - å®šæ—¶å™¨"></a>4.3 Timer - å®šæ—¶å™¨</h3><h4 id="4-3-1-Timer-ç»“æ„ä½“"><a href="#4-3-1-Timer-ç»“æ„ä½“" class="headerlink" title="4.3.1 Timer ç»“æ„ä½“"></a>4.3.1 Timer ç»“æ„ä½“</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CFRunLoop.c - Timer ç»“æ„ä½“</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">CFRunLoopTimer</span> &#123;</span></span><br><span class="line">    CFRuntimeBase _base;</span><br><span class="line">    <span class="type">uint16_t</span> _bits;</span><br><span class="line">    <span class="type">pthread_mutex_t</span> _lock;</span><br><span class="line">    CFRunLoopRef _runLoop;          <span class="comment">// ğŸ‘ˆ æ‰€å± RunLoop</span></span><br><span class="line">    CFMutableSetRef _rlModes;       <span class="comment">// ğŸ‘ˆ æ‰€å±çš„ Mode é›†åˆ</span></span><br><span class="line">    CFAbsoluteTime _nextFireDate;   <span class="comment">// ğŸ‘ˆ ä¸‹æ¬¡è§¦å‘æ—¶é—´</span></span><br><span class="line">    CFTimeInterval _interval;       <span class="comment">// ğŸ‘ˆ æ—¶é—´é—´éš”</span></span><br><span class="line">    CFTimeInterval _tolerance;      <span class="comment">// ğŸ‘ˆ å®¹å¿è¯¯å·®</span></span><br><span class="line">    <span class="type">uint64_t</span> _fireTSR;</span><br><span class="line">    CFIndex _order;                 <span class="comment">// ğŸ‘ˆ ä¼˜å…ˆçº§</span></span><br><span class="line">    CFRunLoopTimerCallBack _callout;  <span class="comment">// ğŸ‘ˆ å›è°ƒå‡½æ•°</span></span><br><span class="line">    CFRunLoopTimerContext _context; <span class="comment">// ğŸ‘ˆ ä¸Šä¸‹æ–‡</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="4-3-2-Timer-è§¦å‘é€»è¾‘"><a href="#4-3-2-Timer-è§¦å‘é€»è¾‘" class="headerlink" title="4.3.2 Timer è§¦å‘é€»è¾‘"></a>4.3.2 Timer è§¦å‘é€»è¾‘</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CFRunLoop.c - å¤„ç† Timer</span></span><br><span class="line"><span class="type">static</span> Boolean __CFRunLoopDoTimers(CFRunLoopRef rl, CFRunLoopModeRef rlm, <span class="type">uint64_t</span> limitTSR) &#123;</span><br><span class="line">    Boolean timerHandled = <span class="literal">false</span>;</span><br><span class="line">    CFMutableArrayRef timers = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    __CFRunLoopTimerFireTSRLock();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ğŸ‘‡ éå†æ‰€æœ‰ Timer</span></span><br><span class="line">    <span class="keyword">for</span> (CFIndex idx = <span class="number">0</span>, cnt = CFArrayGetCount(rlm-&gt;_timers); idx &lt; cnt; idx++) &#123;</span><br><span class="line">        CFRunLoopTimerRef rlt = (CFRunLoopTimerRef)CFArrayGetValueAtIndex(rlm-&gt;_timers, idx);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ğŸ‘‡ æ£€æŸ¥æ˜¯å¦åˆ°è¾¾è§¦å‘æ—¶é—´</span></span><br><span class="line">        <span class="keyword">if</span> (__CFIsValid(rlt) &amp;&amp; !__CFRunLoopTimerIsFiring(rlt)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (rlt-&gt;_fireTSR &lt;= limitTSR) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!timers) timers = CFArrayCreateMutable(kCFAllocatorSystemDefault, <span class="number">0</span>, &amp;kCFTypeArrayCallBacks);</span><br><span class="line">                CFArrayAppendValue(timers, rlt);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    __CFRunLoopTimerFireTSRUnlock();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ğŸ‘‡ ä¾æ¬¡è§¦å‘ Timer</span></span><br><span class="line">    <span class="keyword">for</span> (CFIndex idx = <span class="number">0</span>, cnt = CFArrayGetCount(timers); idx &lt; cnt; idx++) &#123;</span><br><span class="line">        CFRunLoopTimerRef rlt = (CFRunLoopTimerRef)CFArrayGetValueAtIndex(timers, idx);</span><br><span class="line">        __CFRunLoopTimerLock(rlt);</span><br><span class="line">        <span class="keyword">if</span> (__CFIsValid(rlt) &amp;&amp; !__CFRunLoopTimerIsFiring(rlt)) &#123;</span><br><span class="line">            <span class="type">void</span> *context_info = <span class="literal">NULL</span>;</span><br><span class="line">            <span class="type">void</span> (*context_release)(<span class="type">const</span> <span class="type">void</span> *) = <span class="literal">NULL</span>;</span><br><span class="line">            <span class="keyword">if</span> (rlt-&gt;_context.retain) &#123;</span><br><span class="line">                context_info = (<span class="type">void</span> *)rlt-&gt;_context.retain(rlt-&gt;_context.info);</span><br><span class="line">                context_release = rlt-&gt;_context.release;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                context_info = rlt-&gt;_context.info;</span><br><span class="line">            &#125;</span><br><span class="line">            Boolean doInvalidate = (<span class="number">0.0</span> == rlt-&gt;_interval);</span><br><span class="line">            __CFRunLoopTimerSetFiring(rlt);</span><br><span class="line">            __CFRunLoopTimerUnlock(rlt);</span><br><span class="line">            __CFRunLoopTimerFireTSRLock();</span><br><span class="line">            rlt-&gt;_fireTSR = __CFReadTSR() + __CFTimeIntervalToTSR(rlt-&gt;_interval);</span><br><span class="line">            __CFRepositionTimerInMode(rlm, rlt, <span class="literal">true</span>);</span><br><span class="line">            __CFRunLoopTimerFireTSRUnlock();</span><br><span class="line">            __CFArmNextTimerInMode(rlm, rl);</span><br><span class="line">            __CFRunLoopModeUnlock(rlm);</span><br><span class="line">            __CFRunLoopUnlock(rl);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ğŸ‘‡ æ ¸å¿ƒï¼šè°ƒç”¨ Timer å›è°ƒ</span></span><br><span class="line">            __CFRUNLOOP_IS_CALLING_OUT_TO_A_TIMER_CALLBACK_FUNCTION__(rlt-&gt;_callout, rlt, context_info);</span><br><span class="line"></span><br><span class="line">            CHECK_FOR_FORK();</span><br><span class="line">            <span class="keyword">if</span> (doInvalidate) &#123;</span><br><span class="line">                CFRunLoopTimerInvalidate(rlt);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (context_release) &#123;</span><br><span class="line">                context_release(context_info);</span><br><span class="line">            &#125;</span><br><span class="line">            __CFRunLoopLock(rl);</span><br><span class="line">            __CFRunLoopModeLock(rlm);</span><br><span class="line">            __CFRunLoopTimerLock(rlt);</span><br><span class="line">            timerHandled = <span class="literal">true</span>;</span><br><span class="line">            __CFRunLoopTimerUnsetFiring(rlt);</span><br><span class="line">        &#125;</span><br><span class="line">        __CFRunLoopTimerUnlock(rlt);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (timers) CFRelease(timers);</span><br><span class="line">    <span class="keyword">return</span> timerHandled;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Timer ç²¾åº¦åˆ†æ</strong>ï¼š</p>
<a href="../img/RunLoop/image-20260102160521720.png" class="gallery-item" style="box-shadow: none;"> <img src="../img/RunLoop/image-20260102160521720.png" /></a>

<p><strong>ä»£ç ç¤ºä¾‹</strong>ï¼šNSTimer è¯¦è§£</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ViewController.m</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> mark - ç¤ºä¾‹1: åŸºç¡€ Timer (é”™è¯¯åšæ³•)</span></span><br><span class="line">- (<span class="type">void</span>)example1_BasicTimerWrong &#123;</span><br><span class="line">    <span class="comment">// âŒ é—®é¢˜1: å¾ªç¯å¼•ç”¨</span></span><br><span class="line">    <span class="keyword">self</span>.timer = [<span class="built_in">NSTimer</span> scheduledTimerWithTimeInterval:<span class="number">1.0</span></span><br><span class="line">                                                   target:<span class="keyword">self</span></span><br><span class="line">                                                 selector:<span class="keyword">@selector</span>(timerFired:)</span><br><span class="line">                                                 userInfo:<span class="literal">nil</span></span><br><span class="line">                                                  repeats:<span class="literal">YES</span>];</span><br><span class="line">    <span class="comment">// Timer å¼ºå¼•ç”¨ self, self.timer å¼ºå¼•ç”¨ Timer -&gt; å¾ªç¯å¼•ç”¨</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> mark - ç¤ºä¾‹2: è§£å†³å¾ªç¯å¼•ç”¨ (iOS 10+)</span></span><br><span class="line">- (<span class="type">void</span>)example2_FixRetainCycle &#123;</span><br><span class="line">    <span class="comment">// âœ… ä½¿ç”¨ block æ–¹å¼,é¿å…å¾ªç¯å¼•ç”¨</span></span><br><span class="line">    __<span class="keyword">weak</span> <span class="keyword">typeof</span>(<span class="keyword">self</span>) weakSelf = <span class="keyword">self</span>;</span><br><span class="line">    <span class="keyword">self</span>.timer = [<span class="built_in">NSTimer</span> scheduledTimerWithTimeInterval:<span class="number">1.0</span></span><br><span class="line">                                                 repeats:<span class="literal">YES</span></span><br><span class="line">                                                   block:^(<span class="built_in">NSTimer</span> * _Nonnull timer) &#123;</span><br><span class="line">        __<span class="keyword">strong</span> <span class="keyword">typeof</span>(weakSelf) strongSelf = weakSelf;</span><br><span class="line">        <span class="keyword">if</span> (strongSelf) &#123;</span><br><span class="line">            [strongSelf timerFired:timer];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> mark - ç¤ºä¾‹3: æ»‘åŠ¨æ—¶ Timer æš‚åœé—®é¢˜</span></span><br><span class="line">- (<span class="type">void</span>)example3_TimerPausedWhenScrolling &#123;</span><br><span class="line">    <span class="comment">// âŒ é—®é¢˜: æ»‘åŠ¨ UIScrollView æ—¶,Timer æš‚åœ</span></span><br><span class="line">    <span class="keyword">self</span>.timer = [<span class="built_in">NSTimer</span> scheduledTimerWithTimeInterval:<span class="number">1.0</span></span><br><span class="line">                                                   target:<span class="keyword">self</span></span><br><span class="line">                                                 selector:<span class="keyword">@selector</span>(timerFired:)</span><br><span class="line">                                                 userInfo:<span class="literal">nil</span></span><br><span class="line">                                                  repeats:<span class="literal">YES</span>];</span><br><span class="line">    <span class="comment">// åŸå› : Timer é»˜è®¤æ·»åŠ åˆ° NSDefaultRunLoopMode</span></span><br><span class="line">    <span class="comment">// æ»‘åŠ¨æ—¶ RunLoop åˆ‡æ¢åˆ° UITrackingRunLoopMode</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> mark - ç¤ºä¾‹4: è§£å†³æ»‘åŠ¨æš‚åœ (æ–¹æ¡ˆ1: Common Mode)</span></span><br><span class="line">- (<span class="type">void</span>)example4_FixScrollingPause_CommonMode &#123;</span><br><span class="line">    <span class="comment">// âœ… æ·»åŠ åˆ° NSRunLoopCommonModes</span></span><br><span class="line">    <span class="built_in">NSTimer</span> *timer = [<span class="built_in">NSTimer</span> timerWithTimeInterval:<span class="number">1.0</span></span><br><span class="line">                                             target:<span class="keyword">self</span></span><br><span class="line">                                           selector:<span class="keyword">@selector</span>(timerFired:)</span><br><span class="line">                                           userInfo:<span class="literal">nil</span></span><br><span class="line">                                            repeats:<span class="literal">YES</span>];</span><br><span class="line">    [[<span class="built_in">NSRunLoop</span> currentRunLoop] addTimer:timer forMode:<span class="built_in">NSRunLoopCommonModes</span>];</span><br><span class="line">    <span class="keyword">self</span>.timer = timer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> mark - ç¤ºä¾‹5: è§£å†³æ»‘åŠ¨æš‚åœ (æ–¹æ¡ˆ2: GCD Timer)</span></span><br><span class="line">- (<span class="type">void</span>)example5_FixScrollingPause_GCDTimer &#123;</span><br><span class="line">    <span class="comment">// âœ… ä½¿ç”¨ GCD Timer,ä¸å— RunLoop Mode å½±å“</span></span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_get_main_queue();</span><br><span class="line">    dispatch_source_t timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, <span class="number">0</span>, <span class="number">0</span>, queue);</span><br><span class="line"></span><br><span class="line">    dispatch_source_set_timer(timer,</span><br><span class="line">                             DISPATCH_TIME_NOW,</span><br><span class="line">                             <span class="number">1.0</span> * <span class="built_in">NSEC_PER_SEC</span>,  <span class="comment">// é—´éš”1ç§’</span></span><br><span class="line">                             <span class="number">0.1</span> * <span class="built_in">NSEC_PER_SEC</span>); <span class="comment">// è¯¯å·®0.1ç§’</span></span><br><span class="line"></span><br><span class="line">    __<span class="keyword">weak</span> <span class="keyword">typeof</span>(<span class="keyword">self</span>) weakSelf = <span class="keyword">self</span>;</span><br><span class="line">    dispatch_source_set_event_handler(timer, ^&#123;</span><br><span class="line">        __<span class="keyword">strong</span> <span class="keyword">typeof</span>(weakSelf) strongSelf = weakSelf;</span><br><span class="line">        <span class="keyword">if</span> (strongSelf) &#123;</span><br><span class="line">            [strongSelf timerFired:<span class="literal">nil</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    dispatch_resume(timer);</span><br><span class="line">    <span class="keyword">self</span>.gcdTimer = timer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> mark - ç¤ºä¾‹6: è®¾ç½® tolerance ä¼˜åŒ–æ€§èƒ½</span></span><br><span class="line">- (<span class="type">void</span>)example6_SetTolerance &#123;</span><br><span class="line">    <span class="comment">// âœ… è®¾ç½®å®¹å¿è¯¯å·®,ç³»ç»Ÿå¯ä»¥åˆå¹¶å¤šä¸ª Timer,èŠ‚çœç”µé‡</span></span><br><span class="line">    <span class="built_in">NSTimer</span> *timer = [<span class="built_in">NSTimer</span> timerWithTimeInterval:<span class="number">1.0</span></span><br><span class="line">                                             target:<span class="keyword">self</span></span><br><span class="line">                                           selector:<span class="keyword">@selector</span>(timerFired:)</span><br><span class="line">                                           userInfo:<span class="literal">nil</span></span><br><span class="line">                                            repeats:<span class="literal">YES</span>];</span><br><span class="line">    timer.tolerance = <span class="number">0.1</span>;  <span class="comment">// å®¹å¿0.1ç§’è¯¯å·®</span></span><br><span class="line">    [[<span class="built_in">NSRunLoop</span> currentRunLoop] addTimer:timer forMode:<span class="built_in">NSRunLoopCommonModes</span>];</span><br><span class="line">    <span class="keyword">self</span>.timer = timer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> mark - æ¸…ç†</span></span><br><span class="line">- (<span class="type">void</span>)dealloc &#123;</span><br><span class="line">    [<span class="keyword">self</span>.timer invalidate];</span><br><span class="line">    <span class="keyword">self</span>.timer = <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.gcdTimer) &#123;</span><br><span class="line">        dispatch_source_cancel(<span class="keyword">self</span>.gcdTimer);</span><br><span class="line">        <span class="keyword">self</span>.gcdTimer = <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-4-Observer-è§‚å¯Ÿè€…"><a href="#4-4-Observer-è§‚å¯Ÿè€…" class="headerlink" title="4.4 Observer - è§‚å¯Ÿè€…"></a>4.4 Observer - è§‚å¯Ÿè€…</h3><h4 id="4-4-1-Observer-ç»“æ„ä½“"><a href="#4-4-1-Observer-ç»“æ„ä½“" class="headerlink" title="4.4.1 Observer ç»“æ„ä½“"></a>4.4.1 Observer ç»“æ„ä½“</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CFRunLoop.c - Observer ç»“æ„ä½“</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">CFRunLoopObserver</span> &#123;</span></span><br><span class="line">    CFRuntimeBase _base;</span><br><span class="line">    <span class="type">pthread_mutex_t</span> _lock;</span><br><span class="line">    CFRunLoopRef _runLoop;          <span class="comment">// ğŸ‘ˆ æ‰€å± RunLoop</span></span><br><span class="line">    CFIndex _rlCount;</span><br><span class="line">    CFOptionFlags _activities;      <span class="comment">// ğŸ‘ˆ ç›‘å¬çš„æ´»åŠ¨çŠ¶æ€</span></span><br><span class="line">    CFIndex _order;                 <span class="comment">// ğŸ‘ˆ ä¼˜å…ˆçº§</span></span><br><span class="line">    CFRunLoopObserverCallBack _callout;  <span class="comment">// ğŸ‘ˆ å›è°ƒå‡½æ•°</span></span><br><span class="line">    CFRunLoopObserverContext _context;   <span class="comment">// ğŸ‘ˆ ä¸Šä¸‹æ–‡</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Observer å¯ç›‘å¬çš„çŠ¶æ€</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">CF_OPTIONS</span><span class="params">(CFOptionFlags, CFRunLoopActivity)</span> &#123;</span><br><span class="line">    kCFRunLoopEntry         = (<span class="number">1UL</span> &lt;&lt; <span class="number">0</span>),  <span class="comment">// ğŸ‘ˆ å³å°†è¿›å…¥ RunLoop</span></span><br><span class="line">    kCFRunLoopBeforeTimers  = (<span class="number">1UL</span> &lt;&lt; <span class="number">1</span>),  <span class="comment">// ğŸ‘ˆ å³å°†å¤„ç† Timer</span></span><br><span class="line">    kCFRunLoopBeforeSources = (<span class="number">1UL</span> &lt;&lt; <span class="number">2</span>),  <span class="comment">// ğŸ‘ˆ å³å°†å¤„ç† Source</span></span><br><span class="line">    kCFRunLoopBeforeWaiting = (<span class="number">1UL</span> &lt;&lt; <span class="number">5</span>),  <span class="comment">// ğŸ‘ˆ å³å°†ä¼‘çœ </span></span><br><span class="line">    kCFRunLoopAfterWaiting  = (<span class="number">1UL</span> &lt;&lt; <span class="number">6</span>),  <span class="comment">// ğŸ‘ˆ å·²è¢«å”¤é†’</span></span><br><span class="line">    kCFRunLoopExit          = (<span class="number">1UL</span> &lt;&lt; <span class="number">7</span>),  <span class="comment">// ğŸ‘ˆ å³å°†é€€å‡º RunLoop</span></span><br><span class="line">    kCFRunLoopAllActivities = <span class="number">0x0FFFFFFFU</span>  <span class="comment">// ğŸ‘ˆ ç›‘å¬æ‰€æœ‰çŠ¶æ€</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="4-4-2-Observer-è§¦å‘é€»è¾‘"><a href="#4-4-2-Observer-è§¦å‘é€»è¾‘" class="headerlink" title="4.4.2 Observer è§¦å‘é€»è¾‘"></a>4.4.2 Observer è§¦å‘é€»è¾‘</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CFRunLoop.c - è§¦å‘ Observer</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __CFRunLoopDoObservers(CFRunLoopRef rl, CFRunLoopModeRef rlm, CFRunLoopActivity activity) &#123;</span><br><span class="line">    CHECK_FOR_FORK();</span><br><span class="line"></span><br><span class="line">    CFIndex cnt = rlm-&gt;_observers ? CFArrayGetCount(rlm-&gt;_observers) : <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (cnt &lt; <span class="number">1</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ğŸ‘‡ éå†æ‰€æœ‰ Observer</span></span><br><span class="line">    CFRunLoopObserverRef *collectedObservers = (CFRunLoopObserverRef *)<span class="built_in">malloc</span>(cnt * <span class="keyword">sizeof</span>(CFRunLoopObserverRef));</span><br><span class="line">    CFIndex obs_cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (CFIndex idx = <span class="number">0</span>; idx &lt; cnt; idx++) &#123;</span><br><span class="line">        CFRunLoopObserverRef rlo = (CFRunLoopObserverRef)CFArrayGetValueAtIndex(rlm-&gt;_observers, idx);</span><br><span class="line">        <span class="comment">// ğŸ‘‡ æ£€æŸ¥æ˜¯å¦ç›‘å¬å½“å‰ activity</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> != (rlo-&gt;_activities &amp; activity) &amp;&amp; __CFIsValid(rlo) &amp;&amp; !__CFRunLoopObserverIsFiring(rlo)) &#123;</span><br><span class="line">            collectedObservers[obs_cnt++] = (CFRunLoopObserverRef)CFRetain(rlo);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    __CFRunLoopModeUnlock(rlm);</span><br><span class="line">    __CFRunLoopUnlock(rl);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ğŸ‘‡ è§¦å‘æ‰€æœ‰åŒ¹é…çš„ Observer</span></span><br><span class="line">    <span class="keyword">for</span> (CFIndex idx = <span class="number">0</span>; idx &lt; obs_cnt; idx++) &#123;</span><br><span class="line">        CFRunLoopObserverRef rlo = collectedObservers[idx];</span><br><span class="line">        __CFRunLoopObserverLock(rlo);</span><br><span class="line">        <span class="keyword">if</span> (__CFIsValid(rlo)) &#123;</span><br><span class="line">            Boolean doInvalidate = !__CFRunLoopObserverRepeats(rlo);</span><br><span class="line">            __CFRunLoopObserverSetFiring(rlo);</span><br><span class="line">            __CFRunLoopObserverUnlock(rlo);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ğŸ‘‡ æ ¸å¿ƒï¼šè°ƒç”¨ Observer å›è°ƒ</span></span><br><span class="line">            __CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__(rlo-&gt;_callout, rlo, activity, rlo-&gt;_context.info);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (doInvalidate) &#123;</span><br><span class="line">                CFRunLoopObserverInvalidate(rlo);</span><br><span class="line">            &#125;</span><br><span class="line">            __CFRunLoopObserverUnsetFiring(rlo);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            __CFRunLoopObserverUnlock(rlo);</span><br><span class="line">        &#125;</span><br><span class="line">        CFRelease(rlo);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(collectedObservers);</span><br><span class="line"></span><br><span class="line">    __CFRunLoopLock(rl);</span><br><span class="line">    __CFRunLoopModeLock(rlm);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Observer è§¦å‘æ—¶æœº</strong>ï¼š</p>
<a href="../img/RunLoop/image-20260102160536917.png" class="gallery-item" style="box-shadow: none;"> <img src="../img/RunLoop/image-20260102160536917.png" /></a>

<p><strong>ä»£ç ç¤ºä¾‹</strong>ï¼šä½¿ç”¨ Observer ç›‘å¬ RunLoop</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ViewController.m</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> mark - ç¤ºä¾‹1: åŸºç¡€ Observer ä½¿ç”¨</span></span><br><span class="line">- (<span class="type">void</span>)example1_BasicObserver &#123;</span><br><span class="line">    <span class="comment">// 1. åˆ›å»º Observer</span></span><br><span class="line">    <span class="built_in">CFRunLoopObserverRef</span> observer = <span class="built_in">CFRunLoopObserverCreateWithHandler</span>(</span><br><span class="line">        kCFAllocatorDefault,</span><br><span class="line">        kCFRunLoopAllActivities,  <span class="comment">// ç›‘å¬æ‰€æœ‰çŠ¶æ€</span></span><br><span class="line">        <span class="literal">YES</span>,                      <span class="comment">// æ˜¯å¦é‡å¤</span></span><br><span class="line">        <span class="number">0</span>,                        <span class="comment">// ä¼˜å…ˆçº§</span></span><br><span class="line">        ^(<span class="built_in">CFRunLoopObserverRef</span> observer, <span class="built_in">CFRunLoopActivity</span> activity) &#123;</span><br><span class="line">            <span class="keyword">switch</span> (activity) &#123;</span><br><span class="line">                <span class="keyword">case</span> kCFRunLoopEntry:</span><br><span class="line">                    <span class="built_in">NSLog</span>(<span class="string">@&quot;ğŸ“£ kCFRunLoopEntry - RunLoop å³å°†è¿›å…¥&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> kCFRunLoopBeforeTimers:</span><br><span class="line">                    <span class="built_in">NSLog</span>(<span class="string">@&quot;ğŸ“£ kCFRunLoopBeforeTimers - å³å°†å¤„ç† Timer&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> kCFRunLoopBeforeSources:</span><br><span class="line">                    <span class="built_in">NSLog</span>(<span class="string">@&quot;ğŸ“£ kCFRunLoopBeforeSources - å³å°†å¤„ç† Source&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> kCFRunLoopBeforeWaiting:</span><br><span class="line">                    <span class="built_in">NSLog</span>(<span class="string">@&quot;ğŸ“£ kCFRunLoopBeforeWaiting - å³å°†ä¼‘çœ &quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> kCFRunLoopAfterWaiting:</span><br><span class="line">                    <span class="built_in">NSLog</span>(<span class="string">@&quot;ğŸ“£ kCFRunLoopAfterWaiting - å·²è¢«å”¤é†’&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> kCFRunLoopExit:</span><br><span class="line">                    <span class="built_in">NSLog</span>(<span class="string">@&quot;ğŸ“£ kCFRunLoopExit - å³å°†é€€å‡º RunLoop&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. æ·»åŠ åˆ° RunLoop</span></span><br><span class="line">    <span class="built_in">CFRunLoopAddObserver</span>(<span class="built_in">CFRunLoopGetCurrent</span>(), observer, kCFRunLoopDefaultMode);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. é‡Šæ”¾</span></span><br><span class="line">    <span class="built_in">CFRelease</span>(observer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> mark - ç¤ºä¾‹2: å¡é¡¿ç›‘æ§</span></span><br><span class="line">- (<span class="type">void</span>)example2_FPSMonitor &#123;</span><br><span class="line">    __block <span class="built_in">CFAbsoluteTime</span> lastTime = <span class="built_in">CFAbsoluteTimeGetCurrent</span>();</span><br><span class="line">    __block <span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">CFRunLoopObserverRef</span> observer = <span class="built_in">CFRunLoopObserverCreateWithHandler</span>(</span><br><span class="line">        kCFAllocatorDefault,</span><br><span class="line">        kCFRunLoopAllActivities,</span><br><span class="line">        <span class="literal">YES</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        ^(<span class="built_in">CFRunLoopObserverRef</span> observer, <span class="built_in">CFRunLoopActivity</span> activity) &#123;</span><br><span class="line">            <span class="keyword">if</span> (activity == kCFRunLoopBeforeWaiting) &#123;</span><br><span class="line">                <span class="built_in">CFAbsoluteTime</span> currentTime = <span class="built_in">CFAbsoluteTimeGetCurrent</span>();</span><br><span class="line">                <span class="built_in">CFTimeInterval</span> interval = currentTime - lastTime;</span><br><span class="line"></span><br><span class="line">                count++;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// æ¯ç§’è®¡ç®—ä¸€æ¬¡ FPS</span></span><br><span class="line">                <span class="keyword">if</span> (interval &gt;= <span class="number">1.0</span>) &#123;</span><br><span class="line">                    <span class="type">float</span> fps = count / interval;</span><br><span class="line">                    <span class="built_in">NSLog</span>(<span class="string">@&quot;ğŸ“Š FPS: %.2f&quot;</span>, fps);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// æ£€æµ‹å¡é¡¿</span></span><br><span class="line">                    <span class="keyword">if</span> (fps &lt; <span class="number">50</span>) &#123;</span><br><span class="line">                        <span class="built_in">NSLog</span>(<span class="string">@&quot;âš ï¸ æ£€æµ‹åˆ°å¡é¡¿! FPS = %.2f&quot;</span>, fps);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    lastTime = currentTime;</span><br><span class="line">                    count = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="built_in">CFRunLoopAddObserver</span>(<span class="built_in">CFRunLoopGetMain</span>(), observer, kCFRunLoopCommonModes);</span><br><span class="line">    <span class="built_in">CFRelease</span>(observer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> mark - ç¤ºä¾‹3: ç©ºé—²æ—¶æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">- (<span class="type">void</span>)example3_IdleTaskScheduler &#123;</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *idleTasks = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">CFRunLoopObserverRef</span> observer = <span class="built_in">CFRunLoopObserverCreateWithHandler</span>(</span><br><span class="line">        kCFAllocatorDefault,</span><br><span class="line">        kCFRunLoopBeforeWaiting,  <span class="comment">// å³å°†ä¼‘çœ æ—¶æ‰§è¡Œ</span></span><br><span class="line">        <span class="literal">YES</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        ^(<span class="built_in">CFRunLoopObserverRef</span> observer, <span class="built_in">CFRunLoopActivity</span> activity) &#123;</span><br><span class="line">            <span class="keyword">if</span> (idleTasks.count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// å–å‡ºç¬¬ä¸€ä¸ªä»»åŠ¡</span></span><br><span class="line">                <span class="type">void</span> (^task)(<span class="type">void</span>) = idleTasks.firstObject;</span><br><span class="line">                [idleTasks removeObjectAtIndex:<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">                <span class="comment">// æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">                task();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="built_in">CFRunLoopAddObserver</span>(<span class="built_in">CFRunLoopGetMain</span>(), observer, kCFRunLoopDefaultMode);</span><br><span class="line">    <span class="built_in">CFRelease</span>(observer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ·»åŠ ç©ºé—²ä»»åŠ¡</span></span><br><span class="line">    [idleTasks addObject:^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;ğŸ§¹ ç©ºé—²ä»»åŠ¡1: æ¸…ç†ç¼“å­˜&quot;</span>);</span><br><span class="line">    &#125;];</span><br><span class="line">    [idleTasks addObject:^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;ğŸ§¹ ç©ºé—²ä»»åŠ¡2: é¢„åŠ è½½èµ„æº&quot;</span>);</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
</div>
    </div>

    <div class="post-meta">
        <i>
        
            <span>2025-06-04</span>
            
                <span>è¯¥ç¯‡æ–‡ç« è¢« floki</span>
            
            
                <span>æ‰“ä¸Šæ ‡ç­¾:
                    
                    
                        <a href='/tags/%E7%9F%A5%E8%AF%86%E7%B1%BB/'>
                            çŸ¥è¯†ç±»
                        </a>
                    
                        <a href='/tags/iOS/'>
                            iOS
                        </a>
                    
                </span>
             
             
                <span>å½’ä¸ºåˆ†ç±»:
                    
                    
                        <a href='/categories/%E6%8A%80%E6%9C%AF/'>
                            æŠ€æœ¯
                        </a>
                    
                </span>
            
        
        </i>
    </div>
    <br>
    
    
        
            
    
            <div class="post-footer-pre-next">
                

                
                    <span class="post-footer-pre-next-last-span-right">ä¸‹ä¸€ç¯‡ï¼š<a href="/2024/10/17/Effecitve_C++/">Effecitve_C++(ä¸ªäººæ€»ç»“å‘)</a>
                    </span>
                
            </div>
    
        
    

    
        

     
</div>




                    

                    <div class="footer">
    
        <span> 
            â˜ªï¸ 2002 

            
                

            
                
                    / <a href="/contact/"> è”ç³» </a>
                

            
        </span>
       
    
</div>



<!--è¿™æ˜¯æŒ‡ä¸€æ¡çº¿å¾€ä¸‹çš„å†…å®¹-->
<div class="footer-last">
    
            <span>äººç”ŸçŸ­çŸ­3ä¸‡å¤©ï¼Œåˆèƒ½ç•™ä¸‹å¤šå°‘ç—•è¿¹</span>
            
                <span class="footer-last-span-right"><i><a href=""></a><a href=""></a></i></span>
            
    
</div>


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>

    <!--ç›®å½•-->
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tocify/1.9.0/javascripts/jquery.tocify.min.js" type="text/javascript" ></script>
        
<script src="/js/toc.js"></script>

    

    
<script src="/js/randomHeaderContent.js"></script>

    <!--å›åˆ°é¡¶éƒ¨æŒ‰é’®-->
    
        
<script src="/js/returnToTop.js"></script>

    

    
        
<script src="/js/returnToLastPage.js"></script>

    





<script src="/js/lightgallery/lightgallery.umd.min.js"></script>



<script src="/js/lightgallery/plugins/lg-thumbnail.umd.min.js"></script>



<script src="/js/lightgallery/plugins/lg-fullscreen.umd.min.js"></script>


<script src="/js/lightgallery/plugins/lg-autoplay.umd.min.js"></script>


<script src="/js/lightgallery/plugins/lg-zoom.umd.min.js"></script>


<script src="/js/lightgallery/plugins/lg-rotate.umd.min.js"></script>


<script src="/js/lightgallery/plugins/lg-paper.umd.min.js"></script>




<script type="text/javascript">
     
    if (typeof lightGallery !== "undefined") {
        var options1 = {
            selector: '.gallery-item',
            plugins: [lgThumbnail, lgFullscreen, lgAutoplay, lgZoom, lgRotate, lgPager], // å¯ç”¨æ’ä»¶
            thumbnail: true,          // æ˜¾ç¤ºç¼©ç•¥å›¾
            zoom: true,               // å¯ç”¨ç¼©æ”¾åŠŸ
            rotate: true,             // å¯ç”¨æ—‹è½¬åŠŸèƒ½èƒ½
            autoplay: true,        // å¯ç”¨è‡ªåŠ¨æ’­æ”¾åŠŸèƒ½
            fullScreen: true,      // å¯ç”¨å…¨å±åŠŸèƒ½
            pager: false, //é¡µç ,
            zoomFromOrigin: true,   // ä»åŸå§‹ä½ç½®ç¼©æ”¾
            actualSize: true,       // å¯ç”¨æŸ¥çœ‹å®é™…å¤§å°çš„åŠŸèƒ½
            enableZoomAfter: 300,    // å»¶è¿Ÿç¼©æ”¾ï¼Œç¡®ä¿å›¾ç‰‡åŠ è½½å®Œæˆåå¯ç¼©æ”¾
        };
        lightGallery(document.getElementsByClassName('.article-gallery')[0], options1); // ä¿®å¤é€‰æ‹©å™¨
    }
    
</script>


    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> 

                </div>
            
            
                <!-- å›åˆ°é¡¶éƒ¨çš„æŒ‰é’®-->
                <div class="progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            
            
                <!-- è¿”å›çš„æŒ‰é’®-->
                <div class="return-to-last-progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            
    </body>
</html>
<script src="/js/emojiHandler.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        wrapEmojis('.paper');
    });
</script>
